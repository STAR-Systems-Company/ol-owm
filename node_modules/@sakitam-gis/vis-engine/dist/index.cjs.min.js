"use strict";var t=require("gl-matrix"),e=require("gl-matrix/vec2"),s=require("gl-matrix/vec3"),i=require("gl-matrix/quat"),r=require("gl-matrix/vec4"),n=require("gl-matrix/mat3"),h=require("gl-matrix/mat4"),a=require("colord");function o(t,e=[],s=[]){return t.replace(/#defines/,e.join("\n")).replace(/#includes/,s.join("\n"))}function l(t,e="unnamed"){const s=t.match(/#define\s*SHADER_NAME\s*([A-Za-z0-9_-]+)\s*/);return s?s[1]:e}function d(t,e,s,i){const r=new Set;if(i)for(let n=0,h=s;n<h;n+=3){const s=i[n],h=i[n+1],a=i[n+2],o=[s,h,h,a,a,s];for(let s=0;s<o.length;s+=2)u(3*o[s],3*o[s+1],t,r)&&e.push(o[s],o[s+1])}else for(let i=0,n=s;i<n;i+=3){const s=i+1,n=i+2,h=[i,s,s,n,n,i];for(let s=0;s<h.length;s+=2)u(3*h[s],3*h[s+1],t,r)&&e.push(h[s],h[s+1])}return e}function u(t,e,s,i){const r=`${s[t]},${s[t+1]},${s[t+2]}-${s[e]},${s[e+1]},${s[e+2]}`,n=`${s[e]},${s[e+1]},${s[e+2]}-${s[t]},${s[t+1]},${s[t+2]}`;return!0!==i.has(r)&&!0!==i.has(n)&&(i.add(r),i.add(n),!0)}const c=Math.PI/180,m=180/Math.PI;function g(t){return t*c}function p(t){return t*m}function f(t,e,s){return Math.min(Math.max(t,e),s)}function b(t){return Math.log(t)/Math.LN2%1==0}let x=Float32Array;function w(e,s=!0){x=e?Float64Array:Float32Array,s&&t.glMatrix.setMatrixArrayType(x)}function y(){return x}function E(t){return"undefined"!=typeof WebGLRenderingContext&&t instanceof WebGLRenderingContext||("undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||(!(!t?.gl||!(t.gl instanceof WebGLRenderingContext||t.gl instanceof WebGL2RenderingContext))||Boolean(t&&Number.isFinite(t._version))))}function A(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||(!!(t?.gl&&t.gl instanceof WebGL2RenderingContext)||Boolean(t&&2===t._version))}function v(t,e={},s=!1){const i=["webgl2","webgl","experimental-webgl"];s||i.shift();let r=null;function n(t){console.error(t.statusMessage)}t?.addEventListener?.("webglcontextcreationerror",n,!1);for(let s=0;s<i.length;++s){try{r=t.getContext(i[s],e)}catch(t){}if(r)break}return t?.removeEventListener?.("webglcontextcreationerror",n,!1),r}const T=()=>("undefined"==typeof performance?Date:performance).now();function M(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function _(t){return"string"===M(t)}function S(t){return"undefined"===M(t)}function F(t){return _(t)&&t.includes("%")}function R(t){return"number"===M(t)}function C(t){return"regexp"===M(t)}function B(t){return null==t}function O(t){const e=typeof t;return null!==t&&("object"===e||"function"===e)}const L={};function N(t="id"){L[t]=L[t]||1;return`${t}-${L[t]++}`}function U(t,e=[]){return Object.keys(t).filter((t=>e.indexOf(t)<0)).reduce(((e,s)=>Object.assign(e,{[s]:t[s]})),{})}const I=[],P=1e3/60;let D=performance.now();function G(){const t=T(),e=t-D;if(e>=P){D=t-e%P;const s=I.slice();I.length=0;for(let i=0;i<s.length;i++)s[i]&&s[i](t,e)}else setImmediate(G)}function k(t){return"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(t):(e=t,I.push(e),1===I.length&&setImmediate(G),I.length-1);var e}function z(t){return"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(t):void(I[t]=void 0)}var W=Object.freeze({__proto__:null,DEG_TO_RAD:c,RAD_TO_DEG:m,cancelAnimationFrame:z,clamp:f,defineShader:function(t,e={}){return Object.keys(e).reduce(((t,s)=>e[s]?`#define ${s} ${e[s]}\n${t}`:t),t)},degToRad:g,getContext:v,getFloatArrayConstructor:y,getShaderName:l,getWireframeIndex:d,hasValue:function(t,e){return O(t)?!B(t.value)&&(B(e)||t.value===e):!B(t)&&(B(e)||t===e)},highPrecision:w,isHex:F,isNull:B,isNumber:R,isObject:O,isPowerOfTwo:b,isRegexp:C,isString:_,isUndef:S,isUniqueEdge:u,isWebGL:E,isWebGL2:A,now:T,omit:U,parseShader:o,pick:function(t,e=[]){return Object.keys(t).filter((t=>e.indexOf(t)>-1)).reduce(((e,s)=>Object.assign(e,{[s]:t[s]})),{})},radToDeg:p,requestAnimationFrame:k,typeOf:M,uid:N});class j{#t=0;#e=0;#s=!1;running;constructor(t=!0){this.running=t}start(){this.#s||(this.reset(),this.#s=!0)}stop(){this.getElapsedTime(),this.#s=!1,this.running=!1}reset(){this.#t=T(),this.#e=0}getElapsedTime(){return this.getDelta(),this.#e}getDelta(){let t=0;if(this.running&&!this.#s)return this.start(),0;if(this.#s){const e=T();t=(e-this.#t)/1e3,this.#t=e,this.#e=this.#e+t}return t}}const V={autoStart:!0};class q{type;constructor(t,e={}){this.type=t,(Object.getOwnPropertyNames(e)||[]).forEach((t=>{this[t]=e[t]}))}}class H{elements=new(y())(2);fromArray(t,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=t[e+s];return this}toArray(t=[],e=0){let s=0;for(;s<this.elements.length;s++)t[e+s]=this.elements[s];return t}}class $ extends H{elements=new(y())(2);constructor(t=0,e=0){super();const s=this.elements;s[0]=t,s[1]=e}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}fromObject(t){const{x:e,y:s}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),this}toObject(){return{x:this.x,y:this.y}}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.set(t,t)}add(t){return e.add(this.elements,this.elements,t.elements),this}addScalar(t){return e.add(this.elements,this.elements,[t,t]),this}subtract(t){return e.subtract(this.elements,this.elements,t.elements),this}subtractScalar(t){return e.subtract(this.elements,this.elements,[t,t]),this}multiply(t){return e.multiply(this.elements,this.elements,t.elements),this}multiplyScalar(t){return e.multiply(this.elements,this.elements,[t,t]),this}divide(t){return e.divide(this.elements,this.elements,t.elements),this}divideScalar(t){return e.divide(this.elements,this.elements,[t,t]),this}scale(t){return e.scale(this.elements,this.elements,t),this}distanceTo(t){return e.distance(this.elements,t.elements)}length(){return e.length(this.elements)}distanceToSquared(t){return e.squaredDistance(t.elements,this.elements)}angle(){return e.angle(this.elements,[1,0])}angleTo(t){return e.angle(this.elements,t.elements)}dot(t){return e.dot(this.elements,t.elements)}equals(t){return e.equals(this.elements,t.elements)}cross(t){return e.cross(this.elements,this.elements,t.elements),this}negate(){return e.negate(this.elements,this.elements),this}inverse(){return e.inverse(this.elements,this.elements),this}lerp(t,s){return e.lerp(this.elements,this.elements,t.elements,s),this}normalize(){return e.normalize(this.elements,this.elements),this}applyMatrix3(t){return e.transformMat3(this.elements,this.elements,t.elements),this}applyMatrix4(t){return e.transformMat4(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this}clone(){return new $(this.x,this.y)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const Y=[];class X extends H{elements=new(y())(4);#i=[];constructor(t=0,e=0,s=0,i=0){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,r[3]=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t,this.triggerChange()}get y(){return this.elements[1]}set y(t){this.elements[1]=t,this.triggerChange()}get z(){return this.elements[2]}set z(t){this.elements[2]=t,this.triggerChange()}get w(){return this.elements[3]}set w(t){this.elements[3]=t,this.triggerChange()}fromObject({x:t,y:e,z:s,w:i}){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),void 0!==s&&(this.z=s),void 0!==i&&(this.w=i),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromAxisAngle(t,e){return i.setAxisAngle(this.elements,t.elements,e),this.triggerChange(),this}getAxisAngle(t=new Q){const e=i.getAxisAngle(Y,this.elements);return t.set(Y[0],Y[1],Y[2]),e}fromEuler(t){return i.fromEuler(this.elements,p(t.x),p(t.y),p(t.z)),this.triggerChange(),this}fromMat3(t){return i.fromMat3(this.elements,t),this}set(t,e,s,r){return i.set(this.elements,t,e,s,r),this.triggerChange(),this}length(){return i.length(this.elements)}multiply(t,e){return e?i.multiply(this.elements,t.elements,e.elements):i.multiply(this.elements,this.elements,t.elements),this.triggerChange(),this}slerp(t,e){return i.slerp(this.elements,this.elements,t.elements,e),this.triggerChange(),this}invert(){return i.invert(this.elements,this.elements),this.triggerChange(),this}conjugate(){return i.conjugate(this.elements,this.elements),this.triggerChange(),this}normalize(){return i.normalize(this.elements,this.elements),this.triggerChange(),this}dot(t){return i.dot(this.elements,t.elements)}angleTo(t){return i.getAngle(this.elements,t.elements)}clone(){return(new X).copy(this)}copy(t){return i.copy(this.elements,t.elements),this.triggerChange(),this}equals(t){return r.equals(this.elements,t.elements)}onChange(t){this.#i.includes(t)||this.#i.push(t)}triggerChange(){this.#i.forEach((t=>t()))}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class Q extends H{elements=new(y())(3);constructor(t=0,e=0,s=0){super();const i=this.elements;i[0]=t,i[1]=e,i[2]=s}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}get z(){return this.elements[2]}set z(t){this.elements[2]=t}fromObject(t){const{x:e,y:s,z:i}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),void 0!==i&&(this.z=i),this}toObject(){return{x:this.x,y:this.y,z:this.z}}set(t,e,i){return s.set(this.elements,t,e,i),this}setScalar(t){return this.set(t,t,t)}length(){return s.length(this.elements)}add(t){return s.add(this.elements,this.elements,t.elements),this}addScalar(t){return s.add(this.elements,this.elements,[t,t,t]),this}subtract(t){return s.subtract(this.elements,this.elements,t.elements),this}subtractScalar(t){return s.subtract(this.elements,this.elements,[t,t,t]),this}subVectors(t,e){return s.subtract(this.elements,t.elements,e.elements),this}multiply(t){return s.multiply(this.elements,this.elements,t.elements),this}multiplyScalar(t){return s.multiply(this.elements,this.elements,[t,t,t]),this}divide(t){return s.divide(this.elements,this.elements,t.elements),this}divideScalar(t){return s.divide(this.elements,this.elements,[t,t,t]),this}scale(t){return s.scale(this.elements,this.elements,t),this}scaleAndAdd(t,e){return s.scaleAndAdd(this.elements,this.elements,t.elements,e),this}distanceTo(t){return s.distance(this.elements,t.elements)}distanceToSquared(t){return s.squaredDistance(this.elements,t.elements)}angle(t){return s.angle(this.elements,[1,0,0])}angleTo(t){return s.angle(this.elements,t.elements)}dot(t){return s.dot(this.elements,t.elements)}equals(t){return s.equals(this.elements,t.elements)}cross(t){return s.cross(this.elements,this.elements,t.elements),this}negate(){return s.negate(this.elements,this.elements),this}inverse(){return s.inverse(this.elements,this.elements),this}lerp(t,e){return s.lerp(this.elements,this.elements,t.elements,e),this}normalize(){return s.normalize(this.elements,this.elements),this}applyEuler(t){const e=(new X).fromEuler(t);return this.applyQuaternion(e)}applyMatrix3(t){return s.transformMat3(this.elements,this.elements,t.elements),this}applyMatrix4(t){return s.transformMat4(this.elements,this.elements,t.elements),this}applyQuaternion(t){return s.transformQuat(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new Q(this.x,this.y,this.z)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class Z extends H{elements=new(y())(4);constructor(t=0,e=0,s=0,i=0){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,r[3]=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}get z(){return this.elements[2]}set z(t){this.elements[2]=t}get w(){return this.elements[3]}set w(t){this.elements[3]=t}fromObject(t){const{x:e,y:s,z:i,w:r}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),void 0!==i&&(this.z=i),void 0!==r&&(this.w=r),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}set(t,e,s,i){return r.set(this.elements,t,e,s,i),this}setScalar(t){return this.set(t,t,t,t)}add(t){return r.add(this.elements,this.elements,t.elements),this}addScalar(t){return r.add(this.elements,this.elements,[t,t,t,t]),this}subtract(t){return r.subtract(this.elements,this.elements,t.elements),this}subtractScalar(t){return r.subtract(this.elements,this.elements,[t,t,t,t]),this}subVectors(t,e){return r.subtract(this.elements,t.elements,e.elements),this}multiply(t){return r.multiply(this.elements,this.elements,t.elements),this}multiplyScalar(t){return r.multiply(this.elements,this.elements,[t,t,t,t]),this}divide(t){return r.divide(this.elements,this.elements,t.elements),this}divideScalar(t){return r.divide(this.elements,this.elements,[t,t,t,t]),this}scale(t){return r.scale(this.elements,this.elements,t),this}scaleAndAdd(t,e){return r.scaleAndAdd(this.elements,this.elements,t.elements,e),this}distanceTo(t){return r.distance(this.elements,t.elements)}distanceToSquared(t){return r.squaredDistance(this.elements,t.elements)}length(){return r.length(this.elements)}dot(t){return r.dot(this.elements,t.elements)}equals(t){return r.equals(this.elements,t.elements)}cross(t){return r.cross(this.elements,this.elements,t.elements),this}negate(){return r.negate(this.elements,this.elements),this}inverse(){return r.inverse(this.elements,this.elements),this}lerp(t,e){return r.lerp(this.elements,this.elements,t.elements,e),this}normalize(){return r.normalize(this.elements,this.elements),this}applyMatrix4(t){return r.transformMat4(this.elements,this.elements,t.elements),this}applyQuaternion(t){return r.transformQuat(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return new Z(this.x,this.y,this.z,this.w)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class K{elements=new(y())(16);fromArray(t,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=t[e+s];return this}toArray(t=[],e=0){let s=0;for(;s<this.elements.length;s++)t[e+s]=this.elements[s];return t}}class J extends K{elements=new(y())(9);constructor(t=1,e=0,s=0,i=0,r=1,n=0,h=0,a=0,o=1){super();const l=this.elements;l[0]=t,l[1]=e,l[2]=s,l[3]=i,l[4]=r,l[5]=n,l[6]=h,l[7]=a,l[8]=o}get x(){return this.elements[2]}get y(){return this.elements[5]}get z(){return this.elements[8]}static get identity(){return(new J).fromArray(n.identity([]))}set(t,e,s,i,r,h,a,o,l){return n.set(this.elements,t,e,s,i,r,h,a,o,l),this}transpose(){return n.transpose(this.elements,this.elements),this}invert(t=this){return n.invert(this.elements,t.elements),this}adjoint(t=this){return n.adjoint(this.elements,t.elements),this}determinant(){return n.determinant(this.elements)}multiply(t,e){return e?n.multiply(this.elements,t.elements,e.elements):n.multiply(this.elements,this.elements,t.elements),this}premultiply(t,e){return e?n.multiply(this.elements,e.elements,t.elements):n.multiply(this.elements,t.elements,this.elements),this}translate(t){return n.translate(this.elements,this.elements,t.elements),this}rotate(t){return n.rotate(this.elements,this.elements,t),this}scale(t){return n.scale(this.elements,this.elements,t.elements),this}fromTranslation(t){return n.fromTranslation(this.elements,t.elements),this}fromRotation(t){return n.fromRotation(this.elements,t),this}fromScaling(t){return n.fromScaling(this.elements,t.elements),this}fromQuat(t){return n.fromQuat(this.elements,t.elements),this}normalFromMat4(t){return n.normalFromMat4(this.elements,t.elements),this}fromMat4(t){return n.fromMat4(this.elements,t.elements),this}frob(){return n.frob(this.elements)}add(t,e){return e?n.add(this.elements,t.elements,e.elements):n.add(this.elements,this.elements,t.elements),this}subtract(t,e){return e?n.subtract(this.elements,t.elements,e.elements):n.subtract(this.elements,this.elements,t.elements),this}equals(t,e){return e?n.equals(t.elements,e.elements):n.equals(this.elements,t.elements)}fromRotationTranslationScale(t,e,s,i,r){const n=Math.cos(t),h=Math.sin(t);return this.set(i*n,-r*h,0,i*h,r*n,0,e,s,1),this}getNormalMatrix(t){return n.normalFromMat4(this.elements,t.elements),this}copy(t){return n.copy(this.elements,t.elements),this}clone(){return(new J).copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const tt=[];class et extends K{elements=new(y())(16);constructor(t=1,e=0,s=0,i=0,r=0,n=1,h=0,a=0,o=0,l=0,d=1,u=0,c=0,m=0,g=0,p=1){super();const f=this.elements;f[0]=t,f[1]=e,f[2]=s,f[3]=i,f[4]=r,f[5]=n,f[6]=h,f[7]=a,f[8]=o,f[9]=l,f[10]=d,f[11]=u,f[12]=c,f[13]=m,f[14]=g,f[15]=p}get x(){return this.elements[12]}get y(){return this.elements[13]}get z(){return this.elements[14]}get w(){return this.elements[15]}static get identity(){return(new et).fromArray(h.identity([]))}set(t,e,s,i,r,n,a,o,l,d,u,c,m,g,p,f){return h.set(this.elements,t,e,s,i,r,n,a,o,l,d,u,c,m,g,p,f),this}transpose(){return h.transpose(this.elements,this.elements),this}invert(t=this){return h.invert(this.elements,t.elements),this}adjoint(t=this){return h.adjoint(this.elements,t.elements),this}determinant(){return h.determinant(this.elements)}add(t,e){return e?h.add(this.elements,t.elements,e.elements):h.add(this.elements,this.elements,t.elements),this}subtract(t,e){return e?h.subtract(this.elements,t.elements,e.elements):h.subtract(this.elements,this.elements,t.elements),this}multiply(t,e){return e?h.multiply(this.elements,t.elements,e.elements):h.multiply(this.elements,this.elements,t.elements),this}multiplyScalar(t=this,e){return h.multiplyScalar(this.elements,t.elements,e),this}premultiply(t,e){return e?h.multiply(this.elements,e.elements,t.elements):h.multiply(this.elements,t.elements,this.elements),this}translate(t){return h.translate(this.elements,this.elements,t.elements),this}rotate(t){return h.rotate(this.elements,this.elements,t),this}scale(t){return h.scale(this.elements,this.elements,t.elements),this}scaleScalar(t){return h.scale(this.elements,this.elements,[t,t,t]),this}fromTranslation(t){return h.fromTranslation(this.elements,t.elements),this}fromRotation(t,e){return h.fromRotation(this.elements,t,e),this}fromRotationX(t){return h.fromXRotation(this.elements,t),this}fromRotationY(t){return h.fromYRotation(this.elements,t),this}fromRotationZ(t){return h.fromZRotation(this.elements,t),this}fromScale(t){return h.fromScaling(this.elements,t.elements),this}fromRotationTranslation(t,e){return h.fromRotationTranslation(this.elements,t.elements,e.elements),this}fromPerspective(t,e,s,i){return h.perspective(this.elements,g(t),e,s,i),this}fromOrthogonal(t,e,s,i,r,n){return h.ortho(this.elements,t,e,s,i,r,n),this}fromQuat(t){return h.fromQuat(this.elements,t.elements),this}equals(t){return h.equals(this.elements,t.value)}getRotation(t=new X){return h.getRotation(tt,this.elements),t.set(tt[0],tt[1],tt[2],tt[3]),t}getScale(t=new Q){return h.getScaling(tt,this.elements),t.set(tt[0],tt[1],tt[2]),t}getTranslation(t=new Q){return h.getTranslation(tt,this.elements),t.set(tt[0],tt[1],tt[2]),t}rotateX(t){return h.rotateX(this.elements,this.elements,t),this}rotateY(t){return h.rotateY(this.elements,this.elements,t),this}rotateZ(t){return h.rotateZ(this.elements,this.elements,t),this}compose(t,e,s){return h.fromRotationTranslationScale(this.elements,e.elements,t.elements,s.elements),this}decompose(){return{rotation:this.getRotation(),scale:this.getScale(),translation:this.getTranslation()}}copy(t){return h.copy(this.elements,t.elements),this}clone(){return(new et).copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class st extends H{elements=new(y())(3);#i=[];#r="xyz";constructor(t=0,e=0,s=0,i="xyz"){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,this.#r=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t,this.triggerChange()}get y(){return this.elements[1]}set y(t){this.elements[1]=t,this.triggerChange()}get z(){return this.elements[2]}set z(t){this.elements[2]=t,this.triggerChange()}get order(){return this.#r}set order(t){this.#r=t,this.triggerChange()}get roll(){return this.x}set roll(t){this.x=t}get pitch(){return this.y}set pitch(t){this.y=t}get yaw(){return this.z}set yaw(t){this.z=t}fromObject({x:t,y:e,z:s,order:i}){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),void 0!==s&&(this.z=s),void 0!==i&&(this.order=i),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,order:this.order}}fromRotationMatrix(t,e=this.#r,s=!0){const i=t.toArray(),r=i[0],n=i[4],h=i[8],a=i[1],o=i[5],l=i[9],d=i[2],u=i[6],c=i[10];switch(e){case"xyz":this.y=Math.asin(f(h,-1,1)),Math.abs(h)<.9999999?(this.x=Math.atan2(-l,c),this.z=Math.atan2(-n,r)):(this.x=Math.atan2(u,o),this.z=0);break;case"yxz":this.x=Math.asin(-f(l,-1,1)),Math.abs(l)<.9999999?(this.y=Math.atan2(h,c),this.z=Math.atan2(a,o)):(this.y=Math.atan2(-d,r),this.z=0);break;case"zxy":this.x=Math.asin(f(u,-1,1)),Math.abs(u)<.9999999?(this.y=Math.atan2(-d,c),this.z=Math.atan2(-n,o)):(this.y=0,this.z=Math.atan2(a,r));break;case"zyx":this.y=Math.asin(-f(d,-1,1)),Math.abs(d)<.9999999?(this.x=Math.atan2(u,c),this.z=Math.atan2(a,r)):(this.x=0,this.z=Math.atan2(-n,o));break;case"yzx":this.z=Math.asin(f(a,-1,1)),Math.abs(a)<.9999999?(this.x=Math.atan2(-l,o),this.y=Math.atan2(-d,r)):(this.x=0,this.y=Math.atan2(h,c));break;case"xzy":this.z=Math.asin(-f(n,-1,1)),Math.abs(n)<.9999999?(this.x=Math.atan2(u,o),this.y=Math.atan2(h,r)):(this.x=Math.atan2(-l,c),this.y=0);break;default:throw new Error("Unknown Euler angle order")}return this.#r=e,s&&this.triggerChange(),this}fromQuaternion(t){const[e,s,i,r]=t.elements,n=s*s,h=-2*(n+i*i)+1,a=2*(e*s+r*i);let o=-2*(e*i-r*s);const l=2*(s*i+r*e),d=-2*(e*e+n)+1;o=o>1?1:o,o=o<-1?-1:o;const u=Math.atan2(l,d),c=Math.asin(o),m=Math.atan2(a,h);return new st(u,c,m,"zyx")}fromVector3(t,e=this.#r){return this.set(t.x,t.y,t.z,e)}toQuaternion(){const t=Math.cos(.5*this.yaw),e=Math.sin(.5*this.yaw),s=Math.cos(.5*this.roll),i=Math.sin(.5*this.roll),r=Math.cos(.5*this.pitch),n=Math.sin(.5*this.pitch);return new X(t*i*r-e*s*n,t*s*n+e*i*r,e*s*r-t*i*n,t*s*r+e*i*n)}toVector3(){return new Q(this.x,this.y,this.z)}set(t,e,s,i=this.#r){return this.elements[0]=t,this.elements[1]=e,this.elements[2]=s,this.#r=i,this.triggerChange(),this}clone(){return(new st).copy(this)}copy(t){let e=0;for(;e<this.elements.length;e++)this.elements[e]=t.elements[e];return this.#r=t.order,this.triggerChange(),this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.order===t.order}onChange(t){this.#i.includes(t)||this.#i.push(t)}triggerChange(){this.#i.forEach((t=>t()))}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}a.extend([function(t,e){var s={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},i={};for(var r in s)i[s[r]]=r;var n={};t.prototype.toName=function(e){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var r,h,a=i[this.toHex()];if(a)return a;if(null==e?void 0:e.closest){var o=this.toRgb(),l=1/0,d="black";if(!n.length)for(var u in s)n[u]=new t(s[u]).toRgb();for(var c in s){var m=(r=o,h=n[c],Math.pow(r.r-h.r,2)+Math.pow(r.g-h.g,2)+Math.pow(r.b-h.b,2));m<l&&(l=m,d=c)}return d}},e.string.push([function(e){var i=e.toLowerCase(),r="transparent"===i?"#0000":s[i];return r?new t(r).toRgb():null},"name"])}]);const it=(t,e,s)=>{const i=F(t),r=s-e;let n=f(Number.parseFloat(`${t}`),e,s);return i&&(n=Number.parseInt(""+t*s,10)/100),Math.abs(n-s)<1e-6?1:t%r/r};class rt{r;g;b;a;constructor(t=255,e,s,i=1,r=!1){if(this.r=1,this.g=1,this.b=1,this.a=1,S(e)&&S(s))if(R(t)&&t<=255)this.setRGBA(t,t,t,this.a,r);else{const e=a.colord(t).toRgb();e?this.setRGBA(e.r,e.g,e.b,e.a):console.error("Unsupported color value {".concat(String(t),"} provided"))}else this.setRGBA(t,e,s,i)}fromColor(t){const e=a.colord(t).toRgb();return this.setRGBA(e.r,e.g,e.b,e.a)}fromHSL(t,e,s,i=1){const r=a.colord({h:t,s:e,l:s,a:i}).toRgb();return this.setRGBA(r.r,r.g,r.b,r.a)}fromHSV(t,e,s,i=1){const r=a.colord({h:t,s:e,v:s,a:i}).toRgb();return this.setRGBA(r.r,r.g,r.b,r.a)}setRGB(t,e,s){return this.setRGBA(t,e,s,this.a),this}setRGBA(t,e,s,i,r){return this.r=r?t:it(t,0,255),this.g=r?e:it(e,0,255),this.b=r?s:it(s,0,255),this.setAlpha(i),this}setAlpha(t){return this.a=t>1?it(t,0,255):t,this}toHex(){return a.colord(this.toObject()).toHex()}toHSL(){return a.colord(this.toObject()).toHsl()}toHSV(){return a.colord(this.toObject()).toHsv()}toObject(t=!1){const e=t?1:255;return{r:this.r*e,g:this.g*e,b:this.b*e,a:this.a}}toArray(){return[this.r,this.g,this.b,this.a]}toVector(){return(new Z).fromArray(this.toArray())}toVector3(){return(new Q).fromArray(this.toArray())}toString(){return`${this.constructor.name}(${this.r}, ${this.g}, ${this.b}, ${this.a})`}}class nt extends et{frustum(t,e,s,i,r,n,a){return h.frustum(t.elements,e,s,r,i,n,a),this}orthographic(t,e,s,i,r,n){return h.ortho(this.elements,t,e,i,s,r,n),this}perspective(t,e,s,i){return h.perspective(this.elements,t,e,s,i),this}lookAt(t,e=new Q(0,0,0),s=new Q(0,1,0)){return h.lookAt(this.elements,t.elements,e.elements,s.elements),this}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class ht{visible;localMatrix;worldMatrix;matrixAutoUpdate;position;scale;rotation;quaternion;up;children;parent;worldMatrixNeedsUpdate;constructor(){this.visible=!0,this.localMatrix=new nt,this.worldMatrix=new nt,this.matrixAutoUpdate=!0,this.position=new Q,this.scale=new Q(1,1,1),this.rotation=new st,this.quaternion=new X,this.up=new Q(0,1,0),this.parent=null,this.children=[],this.worldMatrixNeedsUpdate=!1,this.rotation.onChange((()=>{this.quaternion.fromEuler(this.rotation)})),this.quaternion.onChange((()=>{this.rotation.fromQuaternion(this.quaternion)}))}add(t,e=!0){this.contains(t)||this.children.push(t),e&&t.setParent(this,!1)}remove(t,e=!0){this.contains(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}contains(t){return this.children.includes(t)}setParent(t,e=!0){this.parent&&t!==this.parent&&this.parent.remove(this,!1),this.parent=t,e&&t&&t.add(this,!1)}traverse(t){if(!t(this))for(let e=0,s=this.children.length;e<s;e++)this.children[e].traverse(t)}lookAt(t,e){e?this.localMatrix.lookAt(this.position,t,this.up):this.localMatrix.lookAt(t,this.position,this.up),this.localMatrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}updateMatrixWorld(t){let e=t;this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||e)&&(null===this.parent?this.worldMatrix.copy(this.localMatrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.localMatrix),this.worldMatrixNeedsUpdate=!1,e=!0);for(let t=0,s=this.children.length;t<s;t++){this.children[t].updateMatrixWorld(e)}}updateMatrix(){this.localMatrix.compose(this.position,this.quaternion,this.scale),this.worldMatrixNeedsUpdate=!0}decompose(){this.localMatrix.getTranslation(this.position),this.localMatrix.getRotation(this.quaternion),this.localMatrix.getScale(this.scale),this.rotation.fromQuaternion(this.quaternion)}clone(){return(new ht).copy(this,!1)}copy(t,e){if(this.visible=t.visible,this.position.copy(t.position),this.scale.copy(t.scale),this.rotation.copy(t.rotation),this.quaternion.copy(t.quaternion),this.up.copy(t.up),this.localMatrix.copy(t.localMatrix),this.worldMatrix.copy(t.worldMatrix),this.matrixAutoUpdate=t.matrixAutoUpdate,e)for(let e=0,s=t.children.length;e<s;e++){const s=t.children[e];this.add(s.clone())}return this}}class at{renderer;constructor(t){this.renderer=t}get gl(){return this.renderer.gl}get rendererState(){return this.renderer.state}}class ot{id;data;type;size;instanced;stride;offset;divisor;normalized;needsUpdate;count;usage;target;buffer;constructor(t,e){const s=Object.assign({},{size:1,normalized:!0,stride:0,offset:0,divisor:0,usage:t.gl.STATIC_DRAW},e);if(this.id=N("attribute"),this.needsUpdate=!1,!e.data||Array.isArray(e.data))throw new TypeError("BufferAttribute: data should be a typed array");var i,r;this.data=s.data,this.size=s.size||1,this.type=s.type||(i=t.gl,(r=s.data)instanceof Float32Array||r instanceof Float64Array?i.FLOAT:r instanceof Uint16Array?i.UNSIGNED_SHORT:r instanceof Uint8Array||r instanceof Uint8ClampedArray?i.UNSIGNED_BYTE:r instanceof Uint32Array?i.UNSIGNED_INT:r instanceof Int8Array?i.BYTE:r instanceof Int16Array?i.SHORT:r instanceof Int32Array?i.INT:void 0),this.normalized=s.normalized||!1,this.stride=s.stride||0,this.offset=s.offset||0,this.divisor=s.divisor||0,this.instanced=s.divisor>0,this.usage=s.usage||t.gl.STATIC_DRAW,s.target&&(this.target=s.target);let n=s.count;void 0!==s.count&&null!==s.count||(n=s.stride?s.data.byteLength/s.stride:s.data.length/s.size),this.count=n}}const lt=new Q;class dt extends at{#n;#h;#a;#o;drawRange;instancedCount;isInstanced;drawMode;constructor(t,e={}){super(t),this.drawRange={start:0,count:0},this.instancedCount=0,this.isInstanced=!1,this.#h=new Map,this.#a=new Map,this.#n=N("geometry"),this.drawMode=this.gl.TRIANGLES,t.bindVertexArray(null),t.state.setActiveGeometry(null);for(const t in e){const s=e[t];if(s instanceof ot)"index"===t?this.setIndex(s):this.addAttribute(t,s);else if(s.data){const e=new ot(this.renderer,s);"index"===t?this.setIndex(e):this.addAttribute(t,e)}}}get id(){return this.#n}get attributes(){return this.#h}get attributesData(){const t={},e=this.#h.entries();for(let s=0;s<this.#h.size;s++){const s=e.next().value;t[s[0]]=U(s[1],["id","buffer"])}return t}get index(){return this.attributes.get("index")}get bounds(){return this.#o}set bounds(t){this.#o=t}addAttribute(t,e){if(e.target||(e.target="index"===t?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER),e.needsUpdate=!1,this.attributes.set(t,e),e.buffer||(e.buffer=this.gl.createBuffer(),this.updateAttribute(e)),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor),console.warn(`Geometry has multiple instanced buffers of different length - instancedCount: ${this.instancedCount}, count: ${e.count}, divisor: ${e.divisor}, attribute: ${t}`);this.instancedCount=e.count*e.divisor}else"index"===t?this.drawRange.count=e.count:this.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}getAttribute(t){return this.attributes.get(t)}setAttributeData(t,e){const s=this.getAttribute(t);s&&(s.data=e,s.needsUpdate=!0)}updateAttribute(t){!t.buffer&&(t.buffer=this.gl.createBuffer()),this.rendererState.boundBuffer!==t.buffer&&(this.gl.bindBuffer(t.target,t.buffer),this.rendererState.boundBuffer=t.buffer),this.gl.bufferData(t.target,t.data,t.usage),t.needsUpdate=!1}removeAttribute(t){this.attributes.delete(t)}setIndex(t){if(t instanceof ot)t.size=1,this.addAttribute("index",t);else{const e=new ot(this.renderer,{data:t.length>65535?new Uint32Array(t):new Uint16Array(t),size:1});this.addAttribute("index",e)}this.drawRange.count=this.index?.count}setVertices(t){const e=[],s=t.length;for(let i=0;i<s;i++){const s=t[i];e.push(s[0],s[1],s[2])}this.addAttribute("position",new ot(this.renderer,{data:new Float32Array(e),size:3}))}setNormals(t){this.addAttribute("normal",new ot(this.renderer,{data:new Float32Array(t),size:2}))}setUVs(t){this.addAttribute("uv",new ot(this.renderer,{data:new Float32Array(t),size:2}))}setColors(t){const e=[];for(let s=0;s<t.length;s++){let i=t[s];i&&(i instanceof Q||i instanceof Z)&&(i=i.toArray()),e.push(i[0],i[1],i[2],i[3]||1)}this.addAttribute("color",new ot(this.renderer,{data:new Float32Array(e),size:4}))}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){const{attributeOrder:e}=t,s=this.renderer.createVertexArray();this.renderer.bindVertexArray(s),this.#a.set(e,s),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach(((t,{name:e,type:s})=>{const i=this.attributes.get(e);if(!i)return;this.gl.bindBuffer(i.target,i.buffer),this.rendererState.boundBuffer=i.buffer;let r=1;s===this.gl.FLOAT_MAT2&&(r=2),s===this.gl.FLOAT_MAT3&&(r=3),s===this.gl.FLOAT_MAT4&&(r=4);const n=i.size/r,h=1===r?0:r*r*r,a=1===r?0:r*r;for(let e=0;e<r;e++){const s=t+e;this.gl.vertexAttribPointer(s,n,i.type,i.normalized,i.stride+h,i.offset+a),this.gl.enableVertexAttribArray(s),this.renderer.vertexAttribDivisor(s,i.divisor)}}));const e=this.attributes.get("index");e&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e.buffer)}computeBoundingBox(t){const{data:e,offset:s=0,stride:i,size:r}=this.attributes.get("position");this.#o||(this.#o={min:new Q,max:new Q,center:new Q,scale:new Q,radius:Number.POSITIVE_INFINITY}),this.#o.min.setScalar(+Number.POSITIVE_INFINITY),this.#o.max.setScalar(Number.NEGATIVE_INFINITY);const n=t||e,h=i||r;for(let t=s;t<n.length;t+=h){const e=n[t+0],s=n[t+1],i=n[t+2];this.#o.min.x=Math.min(e,this.#o.min.x),this.#o.min.y=Math.min(s,this.#o.min.y),this.#o.min.z=Math.min(i,this.#o.min.z),this.#o.max.x=Math.max(e,this.#o.max.x),this.#o.max.y=Math.max(s,this.#o.max.y),this.#o.max.z=Math.max(i,this.#o.max.z)}return this.#o.scale.subVectors(this.#o.max,this.#o.min),this.#o.center.add(this.#o.min).add(this.#o.max).divideScalar(2),this.#o}computeBoundingSphere(t){const{data:e,offset:s=0,stride:i,size:r}=this.attributes.get("position");this.#o||this.computeBoundingBox(t);const n=t||e;let h=0;const a=i||r,o=n.length;for(let t=s;t<o;t+=a)lt.fromArray(n,t),h=Math.max(h,this.#o.center.distanceToSquared(lt));this.#o.radius=Math.sqrt(h)}draw(t,e=this.drawMode){const{start:s,count:i}=this.drawRange,r=`${this.id}_${t.attributeOrder}`;if(this.rendererState.activeGeometryId!==r){this.#a.get(t.attributeOrder)||this.createVAO(t),this.renderer.bindVertexArray(this.#a.get(t.attributeOrder)),this.rendererState.activeGeometryId=r}if(t.attributeLocations.forEach(((t,{name:e})=>{const s=this.getAttribute(e);s&&s.needsUpdate&&this.updateAttribute(s)})),this.isInstanced)if(this.index){const t=this.index.offset+2*s;this.renderer.drawElementsInstanced(e,i,this.index.type,t,this.instancedCount)}else this.renderer.drawArraysInstanced(e,s,i,this.instancedCount);else if(this.index){const t=this.index.offset+2*s;this.gl.drawElements(e,i,this.index.type,t)}else this.gl.drawArrays(e,s,i)}copy(t){const e=t.attributesData;for(const t in e){const s=e[t];if(s instanceof ot)"index"===t?this.setIndex(s):this.addAttribute(t,s);else if(s.data){const e=new ot(this.renderer,s);"index"===t?this.setIndex(e):this.addAttribute(t,e)}}return t.bounds&&(this.bounds={min:(new Q).copy(t.bounds.min),max:(new Q).copy(t.bounds.max),center:(new Q).copy(t.bounds.center),scale:(new Q).copy(t.bounds.scale),radius:t.bounds.radius}),this}clone(){const t=new dt(this.renderer,{}).copy(this);return t.drawMode=this.drawMode,t}destroy(){this.#a.forEach((t=>{this.renderer.deleteVertexArray(t)})),this.#a.clear(),this.#h.forEach((t=>{this.gl.deleteBuffer(t.buffer)})),this.#h.clear()}}class ut extends ht{gl;modelViewMatrix;normalMatrix;renderOrder;zDepth;frustumCulled;mode;renderer;#n;#l;#d;#u;#c;#m;constructor(t,e={}){super();const s=Object.assign({},{mode:t.gl.TRIANGLES,frustumCulled:!0,renderOrder:0},e);this.renderer=t,this.gl=this.renderer.gl,this.modelViewMatrix=new et,this.normalMatrix=new J,this.renderOrder=s.renderOrder,this.frustumCulled=s.frustumCulled,this.zDepth=0,this.#n=s.id||N("mesh"),this.#d=s.geometry,this.#u=s.program,this.#c=Boolean(s.wireframe),this.mode=s.mode,this.#l=s.mode,this.#c&&(this.mode=this.gl.LINES,this.updateWireframeGeometry(this.#c))}get id(){return this.#n}get geometry(){return this.#c?this.#m:this.#d}get program(){return this.#u}set wireframe(t){this.mode=t?this.gl.LINES:this.#l,this.#c=t,this.updateWireframeGeometry(this.#c)}get wireframe(){return this.#c}draw(t={}){const{camera:e,target:s}=t,i={};e?(Object.assign(i,{projectionMatrix:e.projectionMatrix,cameraPosition:e.worldPosition,viewMatrix:e.viewMatrix}),this.modelViewMatrix.multiply(e.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix)):this.modelViewMatrix.copy(this.worldMatrix),Object.assign(i,{resolution:new $(this.renderer.state?.viewport?.width||1,this.renderer.state?.viewport?.height||1),modelMatrix:this.worldMatrix,modelViewMatrix:this.modelViewMatrix,normalMatrix:this.normalMatrix}),Object.keys(i).forEach((t=>{Object.hasOwn(this.program.uniforms,t)||(this.program.uniforms[t]={value:null}),this.program.uniforms[t].value=i[t]})),s&&s.bind(),this.program.use(),this.geometry.draw(this.program,this.mode),s&&s.unbind()}updateWireframeGeometry(t,e=!1){if(this.#d&&(e||!this.#m)){this.#m&&this.#m.destroy();const t=this.#d.attributes.get("position")?.data,e=this.#d.index?.data,s=e?e.length:Math.floor(t.length/3),i=[];this.#d.index?e&&d(t,i,s,e):d(t,i,s);const r=i.length>65536?new Uint32Array(i):new Uint16Array(i);this.#m=new dt(this.renderer,{...this.#d.attributesData,index:{data:r}})}}updateGeometry(t,e=!0){e&&this.#d&&this.#d.destroy(),this.#d=t,this.updateWireframeGeometry(this.#c,!0)}updateProgram(t,e=!0){e&&this.#u&&this.#u.destroy(),this.#u=t}destroy(){this.program.destroy(),this.geometry.destroy()}clone(){return new ut(this.gl,{geometry:this.geometry,program:this.program,frustumCulled:this.frustumCulled,mode:this.mode,renderOrder:this.renderOrder}).copy(this)}copy(t,e=!0){return super.copy(t,e),this.modelViewMatrix.copy(t.modelViewMatrix),this.normalMatrix.copy(t.normalMatrix),this.mode=t.mode,this.renderOrder=t.renderOrder,this.zDepth=t.zDepth,this}}class ct extends ht{clone(){return(new ct).copy(this,!1)}copy(t,e){return super.copy(t,e),this.matrixAutoUpdate=t.matrixAutoUpdate,this}}var mt=(t=>(t[t.NoBlending=0]="NoBlending",t[t.NormalBlending=1]="NormalBlending",t[t.AdditiveBlending=2]="AdditiveBlending",t[t.SubtractiveBlending=3]="SubtractiveBlending",t[t.MultiplyBlending=4]="MultiplyBlending",t[t.CustomBlending=5]="CustomBlending",t))(mt||{});class gt extends at{#g;constructor(t,e){super(t);const{gl:s}=t;this.#g={viewport:{x:0,y:0,width:0,height:0}},this.apply(e||{frontFace:s.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:s.LESS,blending:1,blendFunc:{src:s.ONE,dst:s.ZERO},blendEquation:{modeRGB:s.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new rt(0),stencil:{func:{},opFront:{},opBack:{}}})}get state(){return this.#g}get viewport(){return this.#g.viewport}get textureUnits(){return this.#g.textureUnits}get activeTextureUnit(){return this.#g.activeTextureUnit}set activeTextureUnit(t){this.#g.activeTextureUnit=t}get currentProgramId(){return this.#g.currentProgramId}set currentProgramId(t){this.#g.currentProgramId=t}get activeGeometryId(){return this.#g.activeGeometryId}set activeGeometryId(t){this.#g.activeGeometryId=t}set flipY(t){this.#g.flipY=t}get flipY(){return this.#g.flipY}set unpackAlignment(t){this.#g.unpackAlignment=t}get unpackAlignment(){return this.#g.unpackAlignment}set premultiplyAlpha(t){this.#g.premultiplyAlpha=t}get premultiplyAlpha(){return this.#g.premultiplyAlpha}set boundBuffer(t){this.#g.boundBuffer=t}get boundBuffer(){return this.#g.boundBuffer}set anisotropy(t){this.#g.anisotropy=t}get anisotropy(){return this.#g.anisotropy}apply(t){if(void 0!==t.blending&&null!==t.blending)this.setBlending(t.blending,t);else{if(t.blendFunc){const{src:e,dst:s,srcAlpha:i,dstAlpha:r}=t.blendFunc;this.setBlendFunc(e,s,i,r),this.enable(this.gl.BLEND)}else this.disable(this.gl.BLEND);if(t.blendEquation){const{modeRGB:e,modeAlpha:s}=t.blendEquation;this.setBlendEquation(e,s)}}S(t.cullFace)||B(t.cullFace)||this.setCullFace(t.cullFace),S(t.frontFace)||B(t.frontFace)||this.setFrontFace(t.frontFace),t.depthTest?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST),S(t.depthMask)||B(t.depthMask)||this.setDepthMask(t.depthMask),S(t.depthWrite)||B(t.depthWrite)||this.setDepthMask(t.depthWrite),S(t.depthFunc)||B(t.depthFunc)||this.setDepthFunc(t.depthFunc),S(t.lineWidth)||B(t.lineWidth)||this.setLineWidth(t.lineWidth),this.#g=Object.assign(this.#g,t)}enable(t){!0!==this.#g[t]&&(this.gl.enable(t),this.#g[t]=!0)}disable(t){!1!==this.#g[t]&&(this.gl.disable(t),this.#g[t]=!1)}setViewport(t,e,s=0,i=0){this.#g.viewport.width===t&&this.#g.viewport.height===e||(this.gl.viewport(s,i,t,e),this.#g.viewport={width:t,height:e,x:s,y:i})}setMask(t){this.#g.colorMask!==t&&(this.gl.colorMask(t,t,t,t),this.#g.colorMask=t)}setBlending(t,e){if(this.#g.blending=t,0!==t)if(this.enable(this.gl.BLEND),2===t)this.#g.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE,this.gl.ONE,this.gl.ONE)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE));else if(3===t)this.#g.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR));else if(4===t)this.#g.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR,this.gl.ZERO,this.gl.SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR));else if(1===t)this.#g.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));else if(5===t){if(e?.blendFunc){const{src:t,dst:s,srcAlpha:i,dstAlpha:r}=e.blendFunc;this.setBlendFunc(t,s,i,r),this.enable(this.gl.BLEND)}if(e?.blendEquation){const{modeRGB:t,modeAlpha:s}=e.blendEquation;this.setBlendEquation(t,s)}}else console.error("State: Invalid blending: ",t);else this.disable(this.gl.BLEND)}setBlendFunc(t,e,s,i){t===this.#g.blendFunc?.src&&e===this.#g.blendFunc?.dst&&s===this.#g.blendFunc?.srcAlpha&&i===this.#g.blendFunc?.dstAlpha||(this.#g.blendFunc={src:t,dst:e,srcAlpha:s,dstAlpha:i},S(s)||B(s)||S(i)||B(i)?this.gl.blendFunc(t,e):this.gl.blendFuncSeparate(t,e,s,i))}setBlendEquation(t,e){t===this.#g.blendEquation?.modeRGB&&e===this.#g.blendEquation?.modeAlpha||(this.#g.blendEquation={modeRGB:t,modeAlpha:e},S(e)||B(e)?this.gl.blendEquation(t):this.gl.blendEquationSeparate(t,e))}setClearAlpha(t){this.#g.clearAlpha!==t&&(this.#g.clearAlpha=t)}setClearColor(t,e){this.#g.clearAlpha===e&&this.#g.clearColor===t||(this.#g.clearColor=t,S(e)||B(e)?this.#g.clearAlpha=t.a:this.#g.clearAlpha=e,this.gl.clearColor(t.r,t.g,t.b,this.#g.clearAlpha))}setCullFace(t){this.#g.cullFace!==t&&(t?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.#g.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.#g.frontFace!==t&&(this.#g.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.#g.depthMask!==t&&(this.#g.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.#g.depthFunc!==t&&(this.#g.depthFunc=t,this.gl.depthFunc(t))}setDepthTest(t){this.#g.depthTest!==t&&(this.#g.depthTest=t,t?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST))}setStencilFunc(t,e,s,i){this.#g?.stencil?.func?.cmp===t&&this.#g?.stencil?.func?.ref===e&&this.#g?.stencil?.func?.mask===s||(this.#g?.stencil||(this.#g.stencil={}),this.#g?.stencil?.func||(this.#g.stencil.func={}),this.#g.stencil.func={ref:e,mask:s,cmp:t},i?this.gl.stencilFuncSeparate(i,t,e,s):this.gl.stencilFunc(t,e,s))}setStencilOp(t,e,s,i){return this.#g?.stencil||(this.#g.stencil={}),i&&i!==this.gl.FRONT_AND_BACK?i===this.gl.FRONT?this.#g.stencil?.opFront?.fail!==t||this.#g.stencil?.opFront?.zFail!==e||this.#g.stencil?.opFront?.zPass!==s:i===this.gl.BACK?this.#g.stencil?.opBack?.fail!==t||this.#g.stencil?.opBack?.zFail!==e||this.#g.stencil?.opBack?.zPass!==s:void 0:this.#g.stencil?.opFront?.fail!==t||this.#g.stencil?.opFront?.zFail!==e||this.#g.stencil?.opFront?.zPass!==s||this.#g.stencil?.opBack?.fail!==t||this.#g.stencil?.opBack?.zFail!==e||this.#g.stencil?.opBack?.zPass!==s}setStencilMask(t,e){this.#g.stencil?.mask!==t&&(this.#g.stencil={...this.#g.stencil,mask:t},e?this.gl.stencilMaskSeparate(e,t):this.gl.stencilMask(t))}setActiveTexture(t){this.#g.activeTextureUnit!==t&&(this.#g.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}setLineWidth(t){this.#g.lineWidth!==t&&(this.#g.lineWidth=t,this.gl.lineWidth(t))}setPolygonOffset(t,e,s){t?(this.enable(this.gl.POLYGON_OFFSET_FILL),this.#g.polygonOffsetFactor===e&&this.#g.polygonOffsetUnits===s||(this.gl.polygonOffset(e,s),this.#g.polygonOffsetFactor=e,this.#g.polygonOffsetUnits=s)):this.disable(this.gl.POLYGON_OFFSET_FILL)}bindFramebuffer(t={}){const{target:e=this.gl.FRAMEBUFFER,buffer:s=null}=t;this.#g.framebuffer!==s&&(this.#g.framebuffer=s,this.gl.bindFramebuffer(e,s))}setActiveGeometry(t){this.#g.activeGeometryId=t}reset(t=!0){const e=Object.keys(this.#g);t?(e.filter((t=>["viewport","premultiplyAlpha"].indexOf(t)<0)).forEach((t=>{delete this.#g[t]})),this.bindFramebuffer({buffer:null}),this.apply({frontFace:this.gl.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:this.gl.LESS,blending:1,blendFunc:{src:this.gl.ONE,dst:this.gl.ZERO},blendEquation:{modeRGB:this.gl.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new rt(0),stencil:{func:{},opFront:{},opBack:{}}})):(e.filter((t=>["flipY","framebuffer","textureUnits","activeTextureUnit","activeGeometryId","currentProgramId"].indexOf(t)>-1)).forEach((t=>{delete this.#g[t]})),this.bindFramebuffer({buffer:null}),this.#g.flipY=!1,this.#g.activeGeometryId=-1,this.#g.activeTextureUnit=-1,this.#g.currentProgramId=-1,this.#g.textureUnits=[],this.#g.boundBuffer=null)}}const pt=["WEBGL_depth_texture","OES_texture_half_float","OES_texture_float","OES_standard_derivatives","OES_element_index_uint","EXT_frag_depth","EXT_blend_minmax","EXT_shader_texture_lod","WEBGL_draw_buffers","WEBGL_color_buffer_float"],ft=["EXT_color_buffer_float"],bt=["WEBGL_lose_context","OES_texture_half_float_linear","OES_texture_float_linear","EXT_color_buffer_half_float","WEBGL_debug_renderer_info","EXT_texture_filter_anisotropic"];const xt="Resource subclass must define virtual methods";class wt extends at{#p;#f;id;name;userData;byteLength;options;constructor(t,e={}){super(t),this.id=e?.id||N(this.constructor.name),this.name=e?.name,this.userData=e?.userData,this.#p=e?.handle,this.options=e,void 0===this.#p&&(this.#p=this.createHandle()),this.byteLength=0}get handle(){return this.#p}swapHandle(t){this.#f=this.#p,this.#p=t}restoreHandle(){this.#p=this.#f}destroy(){this.delete()}delete({deleteChildren:t=!1}={}){const e=this.handle&&this.deleteHandle(this.handle);return this.handle&&this.removeStats(),this.#p=null,e&&t&&e.filter(Boolean).forEach((t=>t.delete())),this}bind(t=this.handle){throw new Error(xt)}unbind(){this.bind(null)}removeStats(){throw new Error(xt)}createHandle(){throw new Error(xt)}deleteHandle(){throw new Error(xt)}toString(){return`${this.constructor.name}(${this.id})`}}class yt extends wt{width;height;#b;constructor(t,e={}){super(t,{...e,format:e.format||t.gl.DEPTH_COMPONENT16}),this.#b=this.options.format,this.width=this.options.width,this.height=this.options.height,console.assert(this.width>0&&this.height>0,"Renderbuffer object requires valid width and height greater than zero"),this.bind(),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,this.#b,this.width,this.height)}resize(t,e){t===this.width&&e===this.height||(this.width=t,this.height=e,this.bind(),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.#b,t,e),this.unbind())}bind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.handle)}unbind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}removeStats(){}destroy(){this.unbind(),this.deleteHandle()}createHandle(){return this.gl.createRenderbuffer()}deleteHandle(){this.handle&&this.gl.deleteRenderbuffer(this.handle)}}const Et=new Uint8Array(4);class At extends wt{needsUpdate=!1;textureUnit=0;image;width;height;target;#g={};constructor(t,e={},s=!0){const{gl:i}=t,r={target:i.TEXTURE_2D,type:i.UNSIGNED_BYTE,format:i.RGBA,internalFormat:e.format||i.RGBA,wrapS:i.CLAMP_TO_EDGE,wrapT:i.CLAMP_TO_EDGE,generateMipmaps:!0,minFilter:i.LINEAR,magFilter:i.LINEAR,premultiplyAlpha:!1,unpackAlignment:4,anisotropy:0,flipY:!1,level:0};super(t,Object.assign({},r,e)),this.textureUnit=0,this.image=this.options.image,this.width=this.options.width,this.height=this.options.height,this.target=this.options.target,this.#g.version=-1,this.needsUpdate=Boolean(s),this.needsUpdate&&this.update()}setData(t,e=this.width,s=this.height){this.image=t,this.width=e,this.height=s,this.needsUpdate=!0}setOptions(t){this.options=Object.assign(this.options,t),this.width=this.options.width,this.height=this.options.height,this.needsUpdate=!0}fromSrc(t){return new Promise(((e,s)=>{const i=new Image;i.onload=()=>{this.setData(i,i.width,i.height),e(this)},i.onerror=t=>{s(t)},i.crossOrigin="*",i.src=t}))}update(t=0){const e=!(this.image===this.#g.image&&!this.needsUpdate);if((e||this.rendererState.textureUnits[t]!==this.id||this.rendererState.activeTextureUnit!==t)&&(this.rendererState.setActiveTexture(t),this.bind(t)),e){if(this.needsUpdate=!1,this.options.wrapS!==this.#g.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.options.wrapS),this.#g.wrapS=this.options.wrapS),this.options.wrapT!==this.#g.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.options.wrapT),this.#g.wrapT=this.options.wrapT),this.options.minFilter!==this.#g.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.options.minFilter),this.#g.minFilter=this.options.minFilter),this.options.magFilter!==this.#g.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.options.magFilter),this.#g.magFilter=this.options.magFilter),this.options.flipY!==this.rendererState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.options.flipY),this.rendererState.flipY=this.options.flipY),this.options.premultiplyAlpha!==this.rendererState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha),this.rendererState.premultiplyAlpha=this.options.premultiplyAlpha),this.options.unpackAlignment!==this.rendererState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.options.unpackAlignment),this.rendererState.unpackAlignment=this.options.unpackAlignment),this.options.anisotropy&&this.options.anisotropy!==this.rendererState.anisotropy){const t=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(t){const e=this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT);let s=this.options.anisotropy;this.options.anisotropy>e&&(s=e,console.warn(`[Texture]: Texture.anisotropy option exceeded the maximum allowed value ${e} of the device`)),this.gl.texParameterf(this.target,t.TEXTURE_MAX_ANISOTROPY_EXT,s)}this.rendererState.anisotropy=this.options.anisotropy}this.image?(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.renderer.isWebGL2&&R(this.options.offset)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image,this.options.offset):ArrayBuffer.isView(this.image)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image):this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.options.format,this.options.type,this.image),this.options.generateMipmaps&&(this.renderer.isWebGL2||b(this.image.width)&&b(this.image.height)?this.gl.generateMipmap(this.target):(this.options.generateMipmaps=!1,this.options.wrapS=this.gl.CLAMP_TO_EDGE,this.options.wrapT=this.options.wrapS,this.options.minFilter=this.gl.LINEAR))):this.renderer.isWebGL2&&R(this.options.offset)?this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.options.offset):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Et,this.options.offset):this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Et),this.#g.image=this.image,this.#g.version+=1}}bind(t=this.textureUnit){this.rendererState.textureUnits[this.rendererState.activeTextureUnit]!==this.id&&(this.textureUnit=t,this.rendererState.textureUnits[this.textureUnit]=this.id,this.gl.bindTexture(this.target,this.handle))}unbind(){this.gl.activeTexture(this.gl.TEXTURE0+this.textureUnit),this.gl.bindTexture(this.target,null),delete this.rendererState.textureUnits[this.textureUnit]}destroy(){this.unbind(),super.destroy()}removeStats(){this.#g={version:-1}}createHandle(){return this.gl.createTexture()}deleteHandle(){this.handle&&this.gl.deleteTexture(this.handle)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}}class vt extends At{needsUpdate=!0;constructor(t,e={}){super(t,{...e,image:e.data,premultiplyAlpha:!0,flipY:!1,unpackAlignment:1})}}function Tt(t,e,s,i,r=1,n=1,h=0,a=1,o=1,l=0,d=1,u=2,c=1,m=-1,g=0,p=0){const f=g,b=r/2,x=n/2,w=h/2,y=Math.floor(a),E=Math.floor(o),A=y+1,v=E+1,T=r/y,M=n/E;for(let r=0;r<v;r++){const n=r*M-x;for(let a=0;a<A;a++){if(t[3*g+l]=(a*T-b)*c,t[3*g+d]=n*m,t[3*g+u]=w,e[3*g+l]=0,e[3*g+d]=0,e[3*g+u]=h>=0?1:-1,s[2*g]=a/y,s[2*g+1]=1-r/E,g++,r===E||a===y)continue;const o=f+a+A*r,x=f+a+A*(r+1),v=f+a+1+A*(r+1),M=f+a+1+A*r;i[6*p]=o,i[6*p+1]=x,i[6*p+2]=M,i[6*p+3]=x,i[6*p+4]=v,i[6*p+5]=M,p++}}}const Mt={};function _t(t="id"){Mt[t]=Mt[t]||1;const e=Mt[t];return Mt[t]+=1,"".concat(t,"-").concat(e)}const St=(t,e)=>{switch(e){case t.VERTEX_SHADER:return"vertex-shader";case t.FRAGMENT_SHADER:return"fragment-shader";default:return"unknown"}};class Ft extends wt{#x;#w;sourceCode;constructor(t,e,s,i={}){const r=((t,e)=>{switch(e){case"fragment":return t.FRAGMENT_SHADER;case"vertex":return t.VERTEX_SHADER;default:return}})(t.gl,s);super(t,{name:l(e)||_t(St(t,r))}),console.assert("string"==typeof e,"Shader: GLSL source code must be a JavaScript string"),this.#w=i,this.#x=r,this.sourceCode=this.injectShaderModule(e,i||{}).replace(/\n\n+/gm,"\n\n"),this.createShader(this.sourceCode)}injectShaderModule(t,e={}){return t.replace(/^[\t ]*#glsl_include +<([\w.]+)>/gm,((t,s)=>{let i=e[s];if(void 0===i)throw new Error("Cannot resolve #include <".concat(s,">"));return i=i.replace(/#include </g,"#glsl_include <"),this.injectShaderModule(i,e)}))}createShader(t=this.source){let e=t.replace(/#include </g,"#glsl_include <");if(e=this.injectShaderModule(e,this.#w||{}).replace(/\n\n+/gm,"\n\n"),this.gl.shaderSource(this.handle,e),this.gl.compileShader(this.handle),!this.gl.getShaderParameter(this.handle,this.gl.COMPILE_STATUS)){const t=this.gl.getShaderInfoLog(this.handle)||"";throw this.gl.deleteShader(this.handle),new Error(`${this.toString()}\n${t}\n${function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(e)}`)}}get source(){return this.sourceCode}get shaderType(){return this.#x}getSource(){return this.gl.getShaderSource(this.handle)}setSource(t){const e=l(t);e&&(this.name=_t(e)),this.createShader(t)}removeStats(){}deleteHandle(){this.gl.deleteShader(this.handle)}toString(){return`${St(this.gl,this.shaderType)}:${this.id}`}}class Rt extends Ft{constructor(t,e,s){super(t,e,"vertex",s)}createHandle(){return this.gl.createShader(this.gl.VERTEX_SHADER)}}class Ct extends Ft{constructor(t,e,s){super(t,e,"fragment",s)}createHandle(){return this.gl.createShader(this.gl.FRAGMENT_SHADER)}}const Bt={};function Ot(t,e,s,i){const r=(i=i.length?function(t){const e=t.length,s=t[0].length;if(void 0===s)return t;const i=e*s;let r=Bt[i];r||(Bt[i]=r=new Float32Array(i));for(let i=0;i<e;i++)r.set(t[i],i*s);return r}(i):i).length;switch(e){case WebGLRenderingContext.FLOAT:return r?t.uniform1fv(s,i):t.uniform1f(s,i);case WebGLRenderingContext.FLOAT_VEC2:return t.uniform2fv(s,i);case WebGLRenderingContext.FLOAT_VEC3:return t.uniform3fv(s,i);case WebGLRenderingContext.FLOAT_VEC4:return t.uniform4fv(s,i);case WebGLRenderingContext.BOOL:case WebGLRenderingContext.INT:case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return r?t.uniform1iv(s,i):t.uniform1i(s,i);case WebGLRenderingContext.BOOL_VEC2:case WebGLRenderingContext.INT_VEC2:return t.uniform2iv(s,i);case WebGLRenderingContext.BOOL_VEC3:case WebGLRenderingContext.INT_VEC3:return t.uniform3iv(s,i);case WebGLRenderingContext.BOOL_VEC4:case WebGLRenderingContext.INT_VEC4:return t.uniform4iv(s,i);case WebGLRenderingContext.FLOAT_MAT2:return t.uniformMatrix2fv(s,!1,i);case WebGLRenderingContext.FLOAT_MAT3:return t.uniformMatrix3fv(s,!1,i);case WebGLRenderingContext.FLOAT_MAT4:return t.uniformMatrix4fv(s,!1,i)}}const Lt=new et,Nt=new Q,Ut=new Q;class It extends ht{cameraType;projectionMatrix;viewMatrix;projectionViewMatrix;worldPosition;#y;#E;#A;#v;#T;#o;frustum;constructor({near:t=.1,far:e=100,fov:s=45,aspect:i=1,bounds:r,zoom:n=1}={}){super(),this.cameraType="perspective",this.projectionMatrix=new nt,this.viewMatrix=new et,this.projectionViewMatrix=new nt,this.worldPosition=new Q,this.frustum=new et,this.#y=t,this.#E=e,this.#A=s,this.#v=i,this.#o=r,this.#T=n;const{left:h,right:a,top:o,bottom:l}=r||{};this.cameraType=h||a?"orthographic":"perspective","orthographic"===this.cameraType?this.orthographic(h,a,o,l,t,e,n):this.perspective(s,i,t,e)}get near(){return this.#y}set near(t){this.#y=t,this.updateProjectionMatrix()}get far(){return this.#E}set far(t){this.#E=t,this.updateProjectionMatrix()}get fov(){return this.#A}set fov(t){this.#A=t,this.updateProjectionMatrix()}get aspect(){return this.#v}set aspect(t){this.#v=t,this.updateProjectionMatrix()}get zoom(){return this.#T}set zoom(t){this.#T=t,this.updateProjectionMatrix()}get bounds(){return this.#o}set bounds(t){this.#o=t,this.updateProjectionMatrix()}perspective(t=this.fov,e=this.aspect,s=this.near,i=this.far){this.#A=t,this.#v=e,this.#y=s,this.#E=i,this.projectionMatrix.fromPerspective(t,e,s,i),this.cameraType="perspective"}orthographic(t,e,s,i,r=this.near,n=this.far,h=1){this.#o={left:t,right:e,top:s,bottom:i},this.near=r,this.far=n,this.projectionMatrix.orthographic(t/h,e/h,s/h,i/h,r,n),this.cameraType="orthographic",this.projectionMatrix.frustum(this.frustum,this.#o.left,this.#o.right,this.#o.top,this.#o.bottom,this.#y,this.#E)}lookAt(t){return super.lookAt(t,!0),this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.invert(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}frustumIntersectsMesh(t,e=t.worldMatrix){if(!t.geometry.attributes.position)return!0;if(t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere(),!t.geometry.bounds)return!0;const s=Nt;s.copy(t.geometry.bounds.center),s.applyMatrix4(e);const i=t.geometry.bounds.radius*e.getMaxScaleOnAxis();return this.frustumIntersectsSphere(s,i)}frustumIntersectsSphere(t,e){const s=Ut;for(let i=0;i<6;i++){const r=this.frustum[i];if(s.copy(r).dot(t)+r.constant<-e)return!1}return!0}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(Lt.invert(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateProjectionMatrix(){throw new Error("Camera subclass must define virtual methods")}}exports.BlendType=mt,exports.Box=class extends dt{constructor(t,{width:e=1,height:s=1,depth:i=1,widthSegments:r=1,heightSegments:n=1,depthSegments:h=1,attributes:a={}}={}){const o=Math.floor(r),l=Math.floor(n),d=Math.floor(h),u=o+1,c=l+1,m=d+1,g=u*c*2+u*m*2+c*m*2,p=6*(o*l*2+o*d*2+l*d*2),f=new Float32Array(3*g),b=new Float32Array(3*g),x=new Float32Array(2*g),w=g>65536?new Uint32Array(p):new Uint16Array(p);let y=0,E=0;const A=m*c,v=u*m,T=u*c,M=d*l,_=o*d,S=o*l;Tt(f,b,x,w,i,s,e,h,n,2,1,0,-1,-1,y,E),y+=A,E+=M,Tt(f,b,x,w,i,s,-e,h,n,2,1,0,1,-1,y,E),y+=A,E+=M,Tt(f,b,x,w,e,i,s,h,r,0,2,1,1,1,y,E),y+=v,E+=_,Tt(f,b,x,w,e,i,-s,h,r,0,2,1,1,-1,y,E),y+=v,E+=_,Tt(f,b,x,w,e,s,-i,r,n,0,1,2,-1,-1,y,E),y+=T,E+=S,Tt(f,b,x,w,e,s,i,r,n,0,1,2,1,-1,y,E),super(t,{...a,position:{size:3,data:f},normal:{size:3,data:b},uv:{size:2,data:x},index:{data:w}})}},exports.BufferAttribute=ot,exports.Camera=It,exports.Clock=j,exports.Color=rt,exports.DataTexture=vt,exports.Euler=st,exports.EventEmitter=class{fns;validateEventTypes;constructor({validEventTypes:t=[/.*/]}={}){this.fns=new Map,this.validateEventTypes=t}validateEventType(t){let e=this.validateEventTypes;Array.isArray(this.validateEventTypes)||(e=[this.validateEventTypes]);let s=!0;if(e.forEach((e=>{C(e)&&!e.test(t)&&(s=!1)})),!s)throw new Error(`Invalid Event Type: '${t}'.\nEvent type should be any of: ${e}.`)}on(t,e,s){if(this.validateEventType(t),_(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.on(t,e,s)})),this}return this.has(t)||this.fns.set(t,[]),this.fns.get(t).push(e),this}once(t,e,s){if(this.validateEventType(t),_(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.once(t,e,s)})),this}const i=(...r)=>{this.off(t,i),e.call(s||this,...r)};return this.on(t,i,s)}off(t,e,s){if(this.validateEventType(t),_(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.off(t,e,s)})),this}const i=this.has(t);if(i)if(e){const s=i.filter((t=>t!==e));this.fns.set(t,s)}else this.fns.delete(t);return this}emit(t,e){const s=t instanceof q?t:new q(t,e);this.validateEventType(s.type);const i=this.has(s.type);if(i)return i.map((t=>t.call(this,s)))}has(t){return this.fns.get(t)}clear(){return this.fns.clear(),this}},exports.Geometry=dt,exports.Matrix3=J,exports.Matrix4=et,exports.Mesh=ut,exports.Object3D=ht,exports.OrthographicCamera=class extends It{constructor(t,e,s,i,r,n,h=1){super({bounds:{left:t,right:e,top:s,bottom:i},near:r,far:n,zoom:h})}updateProjectionMatrix(){const{left:t,right:e,top:s,bottom:i}=this.bounds,{zoom:r}=this;this.projectionMatrix.orthographic(t/r,e/r,s/r,i/r,this.near,this.far)}},exports.PerspectiveCamera=class extends It{constructor(t,e,s,i){super({fov:t,aspect:e,near:s,far:i})}updateProjectionMatrix(){this.projectionMatrix.fromPerspective(this.fov,this.aspect,this.near,this.far)}},exports.Plane=class extends dt{constructor(t,{width:e=1,height:s=1,widthSegments:i=1,heightSegments:r=1,attributes:n={}}={}){const h=Math.floor(i),a=Math.floor(r),o=(h+1)*(a+1),l=h*a*6,d=new Float32Array(3*o),u=new Float32Array(3*o),c=new Float32Array(2*o),m=o>65536?new Uint32Array(l):new Uint16Array(l);Tt(d,u,c,m,e,s,0,i,r),super(t,{...n,position:{size:3,data:d},normal:{size:3,data:u},uv:{size:2,data:c},index:{data:m}})}},exports.Program=class extends wt{attributeOrder;uniforms;#M;#_;#S;#F;#R;constructor(t,e={}){super(t,e);const{id:s,vertexShader:i,fragmentShader:r,uniforms:n={},transparent:h=!1,defines:a=[],includes:l={},cullFace:d,frontFace:u=t.gl.CCW,depthTest:c=!0,depthWrite:m=!0,depthFunc:g=t.gl.LESS,blending:p=1,blendFunc:f,blendEquation:b}=e;this.id=s||N("program");const x=[...[].map((t=>"#define ".concat(t))),...a].map((t=>t.startsWith("#define ")?t:"#define ".concat(t)));if(!i||!r)throw new Error(`Program: ${this.id}：must provide vertexShader and fragmentShader`);if(this.#S="string"==typeof i?new Rt(t,o(i,x),l):i,this.#F="string"==typeof r?new Ct(t,o(r,x),l):r,this.gl.attachShader(this.handle,this.#S.handle),this.gl.attachShader(this.handle,this.#F.handle),this.gl.linkProgram(this.handle),this.gl.validateProgram(this.handle),!this.gl.getProgramParameter(this.handle,this.gl.LINK_STATUS))throw new Error("Program:".concat(this.id,": Error linking ").concat(this.gl.getProgramInfoLog(this.handle)));this.uniforms=n,this.#R={blending:p,cullFace:d,frontFace:u,depthTest:c,depthWrite:m,depthFunc:g,blendFunc:f,blendEquation:b},this.#M=new Map,this.#_=new Map,this.#C(n),this.#B(),h&&!f?.src&&(this.renderer.premultipliedAlpha?this.#R.blendFunc={...f,src:this.gl.ONE,dst:this.gl.ONE_MINUS_SRC_ALPHA}:this.#R.blendFunc={...f,src:this.gl.SRC_ALPHA,dst:this.gl.ONE_MINUS_SRC_ALPHA})}get uniformLocations(){return this.#M}get attributeLocations(){return this.#_}get vertexShader(){return this.#S}get fragmentShader(){return this.#F}use(){const t=this.rendererState.currentProgramId===this.id;let e=-1;t||(this.gl.useProgram(this.handle),this.rendererState.currentProgramId=this.id),this.#M.forEach(((t,s)=>{const i=s.name,r=this.uniforms[i];if(!r)return void console.warn("Program:".concat(this.id,": Active uniform ").concat(i," has not been supplied"));if(r&&(S(r.value)||B(r.value)))return void console.warn("Program:".concat(this.id,": Uniform ").concat(i," is missing a value parameter"));let n=r?.value;if(n instanceof At)return e+=1,r.value.update(e),Ot(this.gl,s.type,t.location,e);if((n instanceof K||n instanceof H||n instanceof rt)&&(n=r.value.toArray()),n&&n.length>0&&n[0]instanceof At){const i=[];for(let t=0;t<r.value.length;t++){const s=n[t];e+=1,s.update(e),i.push(e)}return Ot(this.gl,s.type,t.location,i)}Ot(this.gl,s.type,t.location,n)})),this.applyState()}setStates(t,e=!0){e?(this.#R={...this.#R,...U(t,["blendFunc","blendEquation"])},t.blendFunc&&(this.#R.blendFunc={...this.#R.blendFunc,...t.blendFunc}),t.blendEquation&&(this.#R.blendEquation={...this.#R.blendEquation,...t.blendEquation})):this.#R=t}applyState(){this.rendererState.apply(this.#R)}setUniform(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}bind(){this.gl.useProgram(this.handle)}unbind(){this.gl.useProgram(null)}createHandle(){return this.gl.createProgram()}deleteHandle(){this.gl.deleteProgram(this.handle)}#C(t={}){const e=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_UNIFORMS);for(let s=0;s<e;s++){const e=this.gl.getActiveUniform(this.handle,s);if(!e)break;const i=e.name,r=i.match(/(\w+)/g),n={location:this.gl.getUniformLocation(this.handle,i),type:e.type,name:r[0],isStruct:!1};3===r.length?(n.isStructArray=!0,n.structIndex=Number(r[1]),n.structProperty=r[2]):2===r.length&&isNaN(Number(r[1]))&&(n.isStruct=!0,n.structProperty=r[1]);const h=t[i]?.value;S(h)||B(h)||(n.value=t[i].value),this.uniforms[i]=n,this.#M.set(e,n)}}#B(){const t=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_ATTRIBUTES),e=[];for(let s=0;s<t;s++){const t=this.gl.getActiveAttrib(this.handle,s);if(!t)break;const i=this.gl.getAttribLocation(this.handle,t.name);e[i]=t.name,this.#_.set(t,i)}this.attributeOrder=e.join("")}destroy(){this.unbind(),this.deleteHandle()}},exports.ProjectionMatrix=nt,exports.Quaternion=X,exports.Raf=class{options;#O;#L;#N;#U;#I;constructor(t,e={}){this.options={...e,...V},this.#U=new j,this.reset(),this.onVisibilityChange=this.onVisibilityChange.bind(this),this.#I=()=>{const e=this.#U.getElapsedTime();t&&t(e)},this.options.autoStart&&this.start()}get visible(){return this.#N}get animating(){return this.#L}reset(){this.#L=!1,this.#N=!0,void 0!==this.#O&&z(this.#O)}get elapsedTime(){return this.#U.getElapsedTime()}start(){this.#L||(this.#L=!0,this.#U.start(),this.tick(),"undefined"!=typeof window&&window.document&&window.document.addEventListener("visibilitychange",this.onVisibilityChange,!1))}stop(){this.#U.stop(),this.reset(),"undefined"!=typeof window&&window.document&&window.document.removeEventListener("visibilitychange",this.onVisibilityChange,!1)}tick(){this.#L&&this.#N&&(this.#O=k((()=>{this.tick()})),this.#I())}onVisibilityChange(){"undefined"!=typeof window&&window.document&&(this.#N=!window.document.hidden),this.#N&&(this.reset(),this.start())}},exports.RenderBuffer=yt,exports.RenderTarget=class extends wt{#P;#D;depth;width;height;viewport;drawBuffersChanged;drawBuffers;#G;#k;#z;constructor(t,e={}){super(t,{color:1,depth:!0,depthTexture:!1,stencil:!1,...e}),this.#D=new Map,this.#P=new Map,this.depth=Boolean(e.depth),this.drawBuffers=[],this.drawBuffersChanged=!1,this.width=this.options.width,this.height=this.options.height,this.viewport=new Z(0,0,this.width,this.height),this.name=this.options.name;const s=this.options.attachments||[];if(0===s.length){for(let i=0;i<this.options.color;i++){const r={wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,type:this.gl.UNSIGNED_BYTE,format:this.gl.RGBA,flipY:!1,generateMipmaps:!1,...e};let n;n=r.data?new vt(t,r):new At(t,U(r,["data","name","attachments","depthTexture"])),s.push([this.gl.COLOR_ATTACHMENT0+i,n])}if(e.depthTexture&&(t.isWebGL2||!t.isWebGL2&&t.gl.getExtension("WEBGL_depth_texture"))){const e=new At(t,{width:this.width,height:this.height,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,format:this.gl.DEPTH_COMPONENT,internalFormat:t.isWebGL2?this.gl.DEPTH_COMPONENT16:this.gl.DEPTH_COMPONENT,type:this.gl.UNSIGNED_INT});s.push([this.gl.DEPTH_ATTACHMENT,e])}else{const{depth:i,stencil:r}=e;if(i&&!r){const e=new yt(t,{format:this.gl.DEPTH_COMPONENT16,width:this.width,height:this.height});s.push([this.gl.DEPTH_ATTACHMENT,e])}else if(r&&!i){const e=new yt(t,{format:this.gl.STENCIL_INDEX8,width:this.width,height:this.height});s.push([this.gl.STENCIL_ATTACHMENT,e])}else if(i&&r){const e=new yt(t,{format:this.gl.DEPTH_STENCIL,width:this.width,height:this.height});s.push([this.gl.DEPTH_STENCIL_ATTACHMENT,e])}}}this.create(s)}get texture(){return this.#P.values().next().value}set clearColors(t){this.#G=t}get clearColors(){return this.#G}set clearDepth(t){this.#k=t}get clearDepth(){return this.#k}set clearStencil(t){this.#z=t}get clearStencil(){return this.#z}create(t){this.#G=[],this.#k=1,this.#z=0;for(const e of t){const t=e[0],s=e[1];s instanceof yt?this.#D.set(t,s):s instanceof At&&(this.#P.set(t,s),this.drawBuffers.push(t));const i=t-this.gl.COLOR_ATTACHMENT0;this.#G[i]=[0,0,0,0]}if(this.options.color>1)if(this.renderer.isWebGL2)this.gl.drawBuffers(this.drawBuffers);else{const t=this.renderer.extension("WEBGL_draw_buffers");if(!t||!t.drawBuffersWEBGL)throw new Error("Please open the corresponding extension [WEBGL_draw_buffers](https://developer.mozilla.org/en-US/docs/Web/API/WEBGL_draw_buffers#browser_compatibility) and check whether the browser supports it");t.drawBuffersWEBGL(this.drawBuffers)}this.drawBuffersChanged=!0,this.bind(),this.#D.forEach(((t,e)=>{this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,e,this.gl.RENDERBUFFER,t.handle)})),this.#P.forEach(((t,e)=>{this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,e,this.gl.TEXTURE_2D,t.handle,0)})),this.unbind();const e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(e!==this.gl.FRAMEBUFFER_COMPLETE)switch(e){case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}return this.handle}clear(){this.bind();let t=0;if(this.clearColors[0]){const e=this.clearColors[0];this.gl.clearColor(e[0],e[1],e[2],e[3]),t|=this.gl.COLOR_BUFFER_BIT}R(this.#k)&&(this.gl.clearDepth(this.#k),t|=this.gl.DEPTH_BUFFER_BIT),R(this.#z)&&(this.gl.clearStencil(this.#z),t|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(t),this.unbind()}getTexture(t){return this.#P.get(t)}resize(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.#P.forEach((s=>{s.width===t&&s.height===e||(s.width=t,s.height=e,s.needsUpdate=!0,s.update())})),this.#D.forEach((s=>{s.resize(t,e)})),this.viewport.set(0,0,t,e))}bind(t=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(t,this.handle)}unbind(t=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(t,null)}removeStats(){}destroy(){this.#P.forEach((t=>{t.destroy()})),this.#D.forEach((t=>{t.destroy()})),this.deleteHandle()}createHandle(){return this.gl.createFramebuffer()}deleteHandle(){this.handle&&this.gl.deleteFramebuffer(this.handle)}toString(){return`RenderTarget(${this.id},${this.width}x${this.height})`}},exports.Renderer=class{#W;#g;#j;#V;#q;#H;#$;#Y;#X;#Q;#Z;#K;#J;vertexAttribDivisor;drawArraysInstanced;drawElementsInstanced;createVertexArray;bindVertexArray;deleteVertexArray;width;height;constructor(t,e={}){const s=Object.assign({},{autoClear:!0,depth:!0,alpha:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,requestWebGl2:!0,extensions:[]},e);this.#V=Boolean(s.autoClear),this.#q=s.depth,this.#H=s.alpha,this.#$=s.stencil,this.#Y=s.antialias,this.#X=s.premultipliedAlpha,this.#Q=s.preserveDrawingBuffer,this.#W=E(t)||A(t)?t:v(t,{alpha:this.#H,depth:this.#q,stencil:this.#$,antialias:this.#Y,powerPreference:s.powerPreference,premultipliedAlpha:this.#X,preserveDrawingBuffer:this.#Q},s.requestWebGl2);const i=this.#W?.getContextAttributes(),r=this.#W?.getParameter(this.#W.VIEWPORT),n=this.#W?.getParameter(this.#W.UNPACK_FLIP_Y_WEBGL);this.#g=new gt(this),i&&(this.#q=Boolean(i.depth),this.#Y=Boolean(i.antialias),this.#H=Boolean(i.alpha),this.#$=Boolean(i.stencil),this.#X=Boolean(i.premultipliedAlpha),this.#Q=Boolean(i.preserveDrawingBuffer)),this.#g.flipY=Boolean(n),this.#g.setViewport(r[2],r[3],r[0],r[1]),this.#g.premultiplyAlpha=this.#X,this.#Z=!0,this.#K=s.dpr||1,this.width=this.gl.canvas.width/this.#K,this.height=this.gl.canvas.height/this.#K,this.#J=!!s.frustumCull,this.#j={},this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),s.extensions&&(s.extensions.filter((t=>pt.findIndex((e=>e===t))>-1)).forEach((t=>{this.#j[t]||this.isWebGL2||(this.#j[t]=this.gl.getExtension(t))})),s.extensions.filter((t=>ft.findIndex((e=>e===t))>-1)).forEach((t=>{!this.#j[t]&&this.isWebGL2&&(this.#j[t]=this.gl.getExtension(t))})),s.extensions.filter((t=>bt.findIndex((e=>e===t))>-1)).forEach((t=>{this.#j[t]||(this.#j[t]=this.gl.getExtension(t))})))}get gl(){return this.#W}get attributes(){return{dpr:this.#K,flipY:this.#g.flipY,depth:this.#q,color:this.#Z,antialias:this.#Y,alpha:this.#H,stencil:this.#$,autoClear:this.#V,frustumCull:this.#J,premultipliedAlpha:this.#X,preserveDrawingBuffer:this.#Q}}get canvas(){return this.#W.canvas}get isWebGL(){return E(this.gl)}get isWebGL2(){return A(this.gl)}get extensions(){return this.#j}extension(t){return this.#j[t]}get size(){return{width:"clientWidth"in this.canvas?this.canvas.clientWidth:this.canvas.width,height:"clientHeight"in this.canvas?this.canvas.clientHeight:this.canvas.height}}get state(){return this.#g}get premultipliedAlpha(){return this.#X}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.#K,this.gl.canvas.height=e*this.#K}setViewport(t,e,s=0,i=0){this.#g.setViewport(t,e,s,i)}getExtension(t,e,s){const i=this.gl[e];if(e&&i)return i.bind(this.gl);this.#j[t]||(this.#j[t]=this.gl.getExtension(t));const r=this.#j[t];return e?r?r[s].bind(r):null:r}getRenderList({scene:t,camera:e}){const s=[];return t.traverse((t=>{if(!t.visible)return!0;t.draw&&(this.#J&&t.frustumCulled&&e&&!e.frustumIntersectsMesh(t)||s.push(t))})),s}render(t){const{scene:e,camera:s,target:i=null,update:r=!0,clear:n}=t;null===i?(this.#g.bindFramebuffer({buffer:null}),this.setViewport(this.width*this.#K,this.height*this.#K)):(i.bind(),this.setViewport(i.width,i.height)),(n||this.#V&&!1!==n)&&(!this.#q||i&&!i.depth||(this.#g.enable(this.gl.DEPTH_TEST),this.#g.setDepthMask(!0)),this.clear(this.#Z,this.#q,this.#$)),r&&e.updateMatrixWorld(),s&&s.updateMatrixWorld();const h=this.getRenderList({scene:e,camera:s});let a=0;const o=h.length;for(;a<o;a++){h[a].draw({camera:s})}i&&i.unbind()}clear(t=this.#Z,e=this.#q,s=this.#$){let i=0;t&&(i|=this.gl.COLOR_BUFFER_BIT),e&&(i|=this.gl.DEPTH_BUFFER_BIT),s&&(i|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(i)}resetState(t=!0,e=null){this.#g.reset(t),this.bindVertexArray(e)}},exports.Resource=wt,exports.Scene=ct,exports.State=gt,exports.Texture=At,exports.Texture3D=class extends At{needsUpdate=!1;textureUnit=0;depth;#g={};constructor(t,e={}){const s=t.gl,i={target:s.TEXTURE_3D,type:s.UNSIGNED_BYTE,format:s.RGBA,internalFormat:e.format||s.RGBA,wrapS:s.CLAMP_TO_EDGE,wrapT:s.CLAMP_TO_EDGE,wrapR:s.CLAMP_TO_EDGE,generateMipmaps:!0,minFilter:s.LINEAR,magFilter:s.LINEAR,premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,level:0,depth:0};super(t,Object.assign({},i,e),!1),this.needsUpdate=!0,this.depth=this.options.depth,this.#g.version=-1,this.update()}get gl(){return this.renderer.gl}setData(t,e=this.width,s=this.height,i=this.depth){this.image=t,this.width=e,this.height=s,this.depth=i,this.needsUpdate=!0}setOptions(t){this.options=Object.assign(this.options,t),this.width=this.options.width,this.height=this.options.height,this.depth=this.options.depth,this.needsUpdate=!0}update(t=0){const e=!(this.image===this.#g.image&&!this.needsUpdate);if((e||this.rendererState.textureUnits[t]!==this.id||this.rendererState.activeTextureUnit!==t)&&(this.rendererState.setActiveTexture(t),this.bind(t)),e){if(this.needsUpdate=!1,this.options.wrapS!==this.#g.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.options.wrapS),this.#g.wrapS=this.options.wrapS),this.options.wrapT!==this.#g.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.options.wrapT),this.#g.wrapT=this.options.wrapT),this.options.wrapR!==this.#g.wrapR&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_R,this.options.wrapR),this.#g.wrapR=this.options.wrapR),this.options.minFilter!==this.#g.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.options.minFilter),this.#g.minFilter=this.options.minFilter),this.options.magFilter!==this.#g.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.options.magFilter),this.#g.magFilter=this.options.magFilter),this.options.flipY!==this.rendererState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.options.flipY),this.rendererState.flipY=this.options.flipY),this.options.premultiplyAlpha!==this.rendererState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha),this.rendererState.premultiplyAlpha=this.options.premultiplyAlpha),this.options.unpackAlignment!==this.rendererState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.options.unpackAlignment),this.rendererState.unpackAlignment=this.options.unpackAlignment),this.options.anisotropy&&this.options.anisotropy!==this.rendererState.anisotropy){const t=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(t){const e=this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT);let s=this.options.anisotropy;this.options.anisotropy>e&&(s=e,console.warn(`[Texture]: Texture.anisotropy option exceeded the maximum allowed value ${e} of the device`)),this.gl.texParameterf(this.target,t.TEXTURE_MAX_ANISOTROPY_EXT,s)}this.rendererState.anisotropy=this.options.anisotropy}this.image?(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.renderer.isWebGL2&&R(this.options.offset)?this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,this.image,this.options.offset):(ArrayBuffer.isView(this.image),this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,this.image)),this.options.generateMipmaps&&(this.renderer.isWebGL2||b(this.image.width)&&b(this.image.height)?this.gl.generateMipmap(this.target):(this.options.generateMipmaps=!1,this.options.wrapS=this.gl.CLAMP_TO_EDGE,this.options.wrapT=this.options.wrapS,this.options.minFilter=this.gl.LINEAR))):this.width>0?this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,null):this.gl.texImage3D(this.target,0,this.gl.RGBA,1,1,this.depth,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Et),this.#g.image=this.image,this.#g.version+=1}}removeStats(){this.#g={version:-1}}toString(){return`Texture3D(${this.id},${this.width}x${this.height})`}},exports.Vector2=$,exports.Vector3=Q,exports.Vector4=Z,exports.getPlaneBuffer=Tt,exports.highPrecision=w,exports.utils=W;
