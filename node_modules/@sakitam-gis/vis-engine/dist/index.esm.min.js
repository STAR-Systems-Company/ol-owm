import{glMatrix as t}from"gl-matrix";import{add as e,subtract as s,multiply as i,divide as r,scale as n,distance as h,length as a,squaredDistance as o,angle as l,dot as d,equals as u,cross as c,negate as m,inverse as g,lerp as p,normalize as f,transformMat3 as b,transformMat4 as w}from"gl-matrix/vec2";import{set as x,length as y,add as E,subtract as A,multiply as T,divide as v,scale as _,scaleAndAdd as M,distance as S,squaredDistance as F,angle as R,dot as C,equals as O,cross as B,negate as L,inverse as N,lerp as U,normalize as I,transformMat3 as P,transformMat4 as D,transformQuat as G}from"gl-matrix/vec3";import{setAxisAngle as k,getAxisAngle as z,fromEuler as W,fromMat3 as V,set as j,length as H,multiply as q,slerp as $,invert as Y,conjugate as X,normalize as Z,dot as K,getAngle as Q,copy as J}from"gl-matrix/quat";import{equals as tt,set as et,add as st,subtract as it,multiply as rt,divide as nt,scale as ht,scaleAndAdd as at,distance as ot,squaredDistance as lt,length as dt,dot as ut,cross as ct,negate as mt,inverse as gt,lerp as pt,normalize as ft,transformMat4 as bt,transformQuat as wt}from"gl-matrix/vec4";import{identity as xt,set as yt,transpose as Et,invert as At,adjoint as Tt,determinant as vt,multiply as _t,translate as Mt,rotate as St,scale as Ft,fromTranslation as Rt,fromRotation as Ct,fromScaling as Ot,fromQuat as Bt,normalFromMat4 as Lt,fromMat4 as Nt,frob as Ut,add as It,subtract as Pt,equals as Dt,copy as Gt}from"gl-matrix/mat3";import{identity as kt,set as zt,transpose as Wt,invert as Vt,adjoint as jt,determinant as Ht,add as qt,subtract as $t,multiply as Yt,multiplyScalar as Xt,translate as Zt,rotate as Kt,scale as Qt,fromTranslation as Jt,fromRotation as te,fromXRotation as ee,fromYRotation as se,fromZRotation as ie,fromScaling as re,fromRotationTranslation as ne,perspective as he,ortho as ae,fromQuat as oe,equals as le,getRotation as de,getScaling as ue,getTranslation as ce,rotateX as me,rotateY as ge,rotateZ as pe,fromRotationTranslationScale as fe,copy as be,frustum as we,lookAt as xe}from"gl-matrix/mat4";import{extend as ye,colord as Ee}from"colord";function Ae(t,e=[],s=[]){return t.replace(/#defines/,e.join("\n")).replace(/#includes/,s.join("\n"))}function Te(t,e="unnamed"){const s=t.match(/#define\s*SHADER_NAME\s*([A-Za-z0-9_-]+)\s*/);return s?s[1]:e}function ve(t,e,s,i){const r=new Set;if(i)for(let n=0,h=s;n<h;n+=3){const s=i[n],h=i[n+1],a=i[n+2],o=[s,h,h,a,a,s];for(let s=0;s<o.length;s+=2)_e(3*o[s],3*o[s+1],t,r)&&e.push(o[s],o[s+1])}else for(let i=0,n=s;i<n;i+=3){const s=i+1,n=i+2,h=[i,s,s,n,n,i];for(let s=0;s<h.length;s+=2)_e(3*h[s],3*h[s+1],t,r)&&e.push(h[s],h[s+1])}return e}function _e(t,e,s,i){const r=`${s[t]},${s[t+1]},${s[t+2]}-${s[e]},${s[e+1]},${s[e+2]}`,n=`${s[e]},${s[e+1]},${s[e+2]}-${s[t]},${s[t+1]},${s[t+2]}`;return!0!==i.has(r)&&!0!==i.has(n)&&(i.add(r),i.add(n),!0)}const Me=Math.PI/180,Se=180/Math.PI;function Fe(t){return t*Me}function Re(t){return t*Se}function Ce(t,e,s){return Math.min(Math.max(t,e),s)}function Oe(t){return Math.log(t)/Math.LN2%1==0}let Be=Float32Array;function Le(e,s=!0){Be=e?Float64Array:Float32Array,s&&t.setMatrixArrayType(Be)}function Ne(){return Be}function Ue(t){return"undefined"!=typeof WebGLRenderingContext&&t instanceof WebGLRenderingContext||("undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||(!(!t?.gl||!(t.gl instanceof WebGLRenderingContext||t.gl instanceof WebGL2RenderingContext))||Boolean(t&&Number.isFinite(t._version))))}function Ie(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||(!!(t?.gl&&t.gl instanceof WebGL2RenderingContext)||Boolean(t&&2===t._version))}function Pe(t,e={},s=!1){const i=["webgl2","webgl","experimental-webgl"];s||i.shift();let r=null;function n(t){console.error(t.statusMessage)}t?.addEventListener?.("webglcontextcreationerror",n,!1);for(let s=0;s<i.length;++s){try{r=t.getContext(i[s],e)}catch(t){}if(r)break}return t?.removeEventListener?.("webglcontextcreationerror",n,!1),r}const De=()=>("undefined"==typeof performance?Date:performance).now();function Ge(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function ke(t){return"string"===Ge(t)}function ze(t){return"undefined"===Ge(t)}function We(t){return ke(t)&&t.includes("%")}function Ve(t){return"number"===Ge(t)}function je(t){return"regexp"===Ge(t)}function He(t){return null==t}function qe(t){const e=typeof t;return null!==t&&("object"===e||"function"===e)}const $e={};function Ye(t="id"){$e[t]=$e[t]||1;return`${t}-${$e[t]++}`}function Xe(t,e=[]){return Object.keys(t).filter((t=>e.indexOf(t)<0)).reduce(((e,s)=>Object.assign(e,{[s]:t[s]})),{})}const Ze=[],Ke=1e3/60;let Qe=performance.now();function Je(){const t=De(),e=t-Qe;if(e>=Ke){Qe=t-e%Ke;const s=Ze.slice();Ze.length=0;for(let i=0;i<s.length;i++)s[i]&&s[i](t,e)}else setImmediate(Je)}function ts(t){return"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(t):(e=t,Ze.push(e),1===Ze.length&&setImmediate(Je),Ze.length-1);var e}function es(t){return"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(t):void(Ze[t]=void 0)}var ss=Object.freeze({__proto__:null,DEG_TO_RAD:Me,RAD_TO_DEG:Se,cancelAnimationFrame:es,clamp:Ce,defineShader:function(t,e={}){return Object.keys(e).reduce(((t,s)=>e[s]?`#define ${s} ${e[s]}\n${t}`:t),t)},degToRad:Fe,getContext:Pe,getFloatArrayConstructor:Ne,getShaderName:Te,getWireframeIndex:ve,hasValue:function(t,e){return qe(t)?!He(t.value)&&(He(e)||t.value===e):!He(t)&&(He(e)||t===e)},highPrecision:Le,isHex:We,isNull:He,isNumber:Ve,isObject:qe,isPowerOfTwo:Oe,isRegexp:je,isString:ke,isUndef:ze,isUniqueEdge:_e,isWebGL:Ue,isWebGL2:Ie,now:De,omit:Xe,parseShader:Ae,pick:function(t,e=[]){return Object.keys(t).filter((t=>e.indexOf(t)>-1)).reduce(((e,s)=>Object.assign(e,{[s]:t[s]})),{})},radToDeg:Re,requestAnimationFrame:ts,typeOf:Ge,uid:Ye});class is{#t=0;#e=0;#s=!1;running;constructor(t=!0){this.running=t}start(){this.#s||(this.reset(),this.#s=!0)}stop(){this.getElapsedTime(),this.#s=!1,this.running=!1}reset(){this.#t=De(),this.#e=0}getElapsedTime(){return this.getDelta(),this.#e}getDelta(){let t=0;if(this.running&&!this.#s)return this.start(),0;if(this.#s){const e=De();t=(e-this.#t)/1e3,this.#t=e,this.#e=this.#e+t}return t}}const rs={autoStart:!0};class ns{options;#i;#r;#n;#h;#a;constructor(t,e={}){this.options={...e,...rs},this.#h=new is,this.reset(),this.onVisibilityChange=this.onVisibilityChange.bind(this),this.#a=()=>{const e=this.#h.getElapsedTime();t&&t(e)},this.options.autoStart&&this.start()}get visible(){return this.#n}get animating(){return this.#r}reset(){this.#r=!1,this.#n=!0,void 0!==this.#i&&es(this.#i)}get elapsedTime(){return this.#h.getElapsedTime()}start(){this.#r||(this.#r=!0,this.#h.start(),this.tick(),"undefined"!=typeof window&&window.document&&window.document.addEventListener("visibilitychange",this.onVisibilityChange,!1))}stop(){this.#h.stop(),this.reset(),"undefined"!=typeof window&&window.document&&window.document.removeEventListener("visibilitychange",this.onVisibilityChange,!1)}tick(){this.#r&&this.#n&&(this.#i=ts((()=>{this.tick()})),this.#a())}onVisibilityChange(){"undefined"!=typeof window&&window.document&&(this.#n=!window.document.hidden),this.#n&&(this.reset(),this.start())}}class hs{type;constructor(t,e={}){this.type=t,(Object.getOwnPropertyNames(e)||[]).forEach((t=>{this[t]=e[t]}))}}class as{fns;validateEventTypes;constructor({validEventTypes:t=[/.*/]}={}){this.fns=new Map,this.validateEventTypes=t}validateEventType(t){let e=this.validateEventTypes;Array.isArray(this.validateEventTypes)||(e=[this.validateEventTypes]);let s=!0;if(e.forEach((e=>{je(e)&&!e.test(t)&&(s=!1)})),!s)throw new Error(`Invalid Event Type: '${t}'.\nEvent type should be any of: ${e}.`)}on(t,e,s){if(this.validateEventType(t),ke(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.on(t,e,s)})),this}return this.has(t)||this.fns.set(t,[]),this.fns.get(t).push(e),this}once(t,e,s){if(this.validateEventType(t),ke(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.once(t,e,s)})),this}const i=(...r)=>{this.off(t,i),e.call(s||this,...r)};return this.on(t,i,s)}off(t,e,s){if(this.validateEventType(t),ke(t)){const i=t.split(" ");if(i.length>1)return i.forEach((t=>{this.off(t,e,s)})),this}const i=this.has(t);if(i)if(e){const s=i.filter((t=>t!==e));this.fns.set(t,s)}else this.fns.delete(t);return this}emit(t,e){const s=t instanceof hs?t:new hs(t,e);this.validateEventType(s.type);const i=this.has(s.type);if(i)return i.map((t=>t.call(this,s)))}has(t){return this.fns.get(t)}clear(){return this.fns.clear(),this}}class os{elements=new(Ne())(2);fromArray(t,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=t[e+s];return this}toArray(t=[],e=0){let s=0;for(;s<this.elements.length;s++)t[e+s]=this.elements[s];return t}}class ls extends os{elements=new(Ne())(2);constructor(t=0,e=0){super();const s=this.elements;s[0]=t,s[1]=e}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}fromObject(t){const{x:e,y:s}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),this}toObject(){return{x:this.x,y:this.y}}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.set(t,t)}add(t){return e(this.elements,this.elements,t.elements),this}addScalar(t){return e(this.elements,this.elements,[t,t]),this}subtract(t){return s(this.elements,this.elements,t.elements),this}subtractScalar(t){return s(this.elements,this.elements,[t,t]),this}multiply(t){return i(this.elements,this.elements,t.elements),this}multiplyScalar(t){return i(this.elements,this.elements,[t,t]),this}divide(t){return r(this.elements,this.elements,t.elements),this}divideScalar(t){return r(this.elements,this.elements,[t,t]),this}scale(t){return n(this.elements,this.elements,t),this}distanceTo(t){return h(this.elements,t.elements)}length(){return a(this.elements)}distanceToSquared(t){return o(t.elements,this.elements)}angle(){return l(this.elements,[1,0])}angleTo(t){return l(this.elements,t.elements)}dot(t){return d(this.elements,t.elements)}equals(t){return u(this.elements,t.elements)}cross(t){return c(this.elements,this.elements,t.elements),this}negate(){return m(this.elements,this.elements),this}inverse(){return g(this.elements,this.elements),this}lerp(t,e){return p(this.elements,this.elements,t.elements,e),this}normalize(){return f(this.elements,this.elements),this}applyMatrix3(t){return b(this.elements,this.elements,t.elements),this}applyMatrix4(t){return w(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this}clone(){return new ls(this.x,this.y)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const ds=[];class us extends os{elements=new(Ne())(4);#o=[];constructor(t=0,e=0,s=0,i=0){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,r[3]=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t,this.triggerChange()}get y(){return this.elements[1]}set y(t){this.elements[1]=t,this.triggerChange()}get z(){return this.elements[2]}set z(t){this.elements[2]=t,this.triggerChange()}get w(){return this.elements[3]}set w(t){this.elements[3]=t,this.triggerChange()}fromObject({x:t,y:e,z:s,w:i}){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),void 0!==s&&(this.z=s),void 0!==i&&(this.w=i),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromAxisAngle(t,e){return k(this.elements,t.elements,e),this.triggerChange(),this}getAxisAngle(t=new cs){const e=z(ds,this.elements);return t.set(ds[0],ds[1],ds[2]),e}fromEuler(t){return W(this.elements,Re(t.x),Re(t.y),Re(t.z)),this.triggerChange(),this}fromMat3(t){return V(this.elements,t),this}set(t,e,s,i){return j(this.elements,t,e,s,i),this.triggerChange(),this}length(){return H(this.elements)}multiply(t,e){return e?q(this.elements,t.elements,e.elements):q(this.elements,this.elements,t.elements),this.triggerChange(),this}slerp(t,e){return $(this.elements,this.elements,t.elements,e),this.triggerChange(),this}invert(){return Y(this.elements,this.elements),this.triggerChange(),this}conjugate(){return X(this.elements,this.elements),this.triggerChange(),this}normalize(){return Z(this.elements,this.elements),this.triggerChange(),this}dot(t){return K(this.elements,t.elements)}angleTo(t){return Q(this.elements,t.elements)}clone(){return(new us).copy(this)}copy(t){return J(this.elements,t.elements),this.triggerChange(),this}equals(t){return tt(this.elements,t.elements)}onChange(t){this.#o.includes(t)||this.#o.push(t)}triggerChange(){this.#o.forEach((t=>t()))}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class cs extends os{elements=new(Ne())(3);constructor(t=0,e=0,s=0){super();const i=this.elements;i[0]=t,i[1]=e,i[2]=s}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}get z(){return this.elements[2]}set z(t){this.elements[2]=t}fromObject(t){const{x:e,y:s,z:i}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),void 0!==i&&(this.z=i),this}toObject(){return{x:this.x,y:this.y,z:this.z}}set(t,e,s){return x(this.elements,t,e,s),this}setScalar(t){return this.set(t,t,t)}length(){return y(this.elements)}add(t){return E(this.elements,this.elements,t.elements),this}addScalar(t){return E(this.elements,this.elements,[t,t,t]),this}subtract(t){return A(this.elements,this.elements,t.elements),this}subtractScalar(t){return A(this.elements,this.elements,[t,t,t]),this}subVectors(t,e){return A(this.elements,t.elements,e.elements),this}multiply(t){return T(this.elements,this.elements,t.elements),this}multiplyScalar(t){return T(this.elements,this.elements,[t,t,t]),this}divide(t){return v(this.elements,this.elements,t.elements),this}divideScalar(t){return v(this.elements,this.elements,[t,t,t]),this}scale(t){return _(this.elements,this.elements,t),this}scaleAndAdd(t,e){return M(this.elements,this.elements,t.elements,e),this}distanceTo(t){return S(this.elements,t.elements)}distanceToSquared(t){return F(this.elements,t.elements)}angle(t){return R(this.elements,[1,0,0])}angleTo(t){return R(this.elements,t.elements)}dot(t){return C(this.elements,t.elements)}equals(t){return O(this.elements,t.elements)}cross(t){return B(this.elements,this.elements,t.elements),this}negate(){return L(this.elements,this.elements),this}inverse(){return N(this.elements,this.elements),this}lerp(t,e){return U(this.elements,this.elements,t.elements,e),this}normalize(){return I(this.elements,this.elements),this}applyEuler(t){const e=(new us).fromEuler(t);return this.applyQuaternion(e)}applyMatrix3(t){return P(this.elements,this.elements,t.elements),this}applyMatrix4(t){return D(this.elements,this.elements,t.elements),this}applyQuaternion(t){return G(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return new cs(this.x,this.y,this.z)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class ms extends os{elements=new(Ne())(4);constructor(t=0,e=0,s=0,i=0){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,r[3]=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t}get y(){return this.elements[1]}set y(t){this.elements[1]=t}get z(){return this.elements[2]}set z(t){this.elements[2]=t}get w(){return this.elements[3]}set w(t){this.elements[3]=t}fromObject(t){const{x:e,y:s,z:i,w:r}=t;return void 0!==e&&(this.x=e),void 0!==s&&(this.y=s),void 0!==i&&(this.z=i),void 0!==r&&(this.w=r),this}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}set(t,e,s,i){return et(this.elements,t,e,s,i),this}setScalar(t){return this.set(t,t,t,t)}add(t){return st(this.elements,this.elements,t.elements),this}addScalar(t){return st(this.elements,this.elements,[t,t,t,t]),this}subtract(t){return it(this.elements,this.elements,t.elements),this}subtractScalar(t){return it(this.elements,this.elements,[t,t,t,t]),this}subVectors(t,e){return it(this.elements,t.elements,e.elements),this}multiply(t){return rt(this.elements,this.elements,t.elements),this}multiplyScalar(t){return rt(this.elements,this.elements,[t,t,t,t]),this}divide(t){return nt(this.elements,this.elements,t.elements),this}divideScalar(t){return nt(this.elements,this.elements,[t,t,t,t]),this}scale(t){return ht(this.elements,this.elements,t),this}scaleAndAdd(t,e){return at(this.elements,this.elements,t.elements,e),this}distanceTo(t){return ot(this.elements,t.elements)}distanceToSquared(t){return lt(this.elements,t.elements)}length(){return dt(this.elements)}dot(t){return ut(this.elements,t.elements)}equals(t){return tt(this.elements,t.elements)}cross(t){return ct(this.elements,this.elements,t.elements),this}negate(){return mt(this.elements,this.elements),this}inverse(){return gt(this.elements,this.elements),this}lerp(t,e){return pt(this.elements,this.elements,t.elements,e),this}normalize(){return ft(this.elements,this.elements),this}applyMatrix4(t){return bt(this.elements,this.elements,t.elements),this}applyQuaternion(t){return wt(this.elements,this.elements,t.elements),this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return new ms(this.x,this.y,this.z,this.w)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class gs{elements=new(Ne())(16);fromArray(t,e=0){let s=0;for(;s<this.elements.length;s++)this.elements[s]=t[e+s];return this}toArray(t=[],e=0){let s=0;for(;s<this.elements.length;s++)t[e+s]=this.elements[s];return t}}class ps extends gs{elements=new(Ne())(9);constructor(t=1,e=0,s=0,i=0,r=1,n=0,h=0,a=0,o=1){super();const l=this.elements;l[0]=t,l[1]=e,l[2]=s,l[3]=i,l[4]=r,l[5]=n,l[6]=h,l[7]=a,l[8]=o}get x(){return this.elements[2]}get y(){return this.elements[5]}get z(){return this.elements[8]}static get identity(){return(new ps).fromArray(xt([]))}set(t,e,s,i,r,n,h,a,o){return yt(this.elements,t,e,s,i,r,n,h,a,o),this}transpose(){return Et(this.elements,this.elements),this}invert(t=this){return At(this.elements,t.elements),this}adjoint(t=this){return Tt(this.elements,t.elements),this}determinant(){return vt(this.elements)}multiply(t,e){return e?_t(this.elements,t.elements,e.elements):_t(this.elements,this.elements,t.elements),this}premultiply(t,e){return e?_t(this.elements,e.elements,t.elements):_t(this.elements,t.elements,this.elements),this}translate(t){return Mt(this.elements,this.elements,t.elements),this}rotate(t){return St(this.elements,this.elements,t),this}scale(t){return Ft(this.elements,this.elements,t.elements),this}fromTranslation(t){return Rt(this.elements,t.elements),this}fromRotation(t){return Ct(this.elements,t),this}fromScaling(t){return Ot(this.elements,t.elements),this}fromQuat(t){return Bt(this.elements,t.elements),this}normalFromMat4(t){return Lt(this.elements,t.elements),this}fromMat4(t){return Nt(this.elements,t.elements),this}frob(){return Ut(this.elements)}add(t,e){return e?It(this.elements,t.elements,e.elements):It(this.elements,this.elements,t.elements),this}subtract(t,e){return e?Pt(this.elements,t.elements,e.elements):Pt(this.elements,this.elements,t.elements),this}equals(t,e){return e?Dt(t.elements,e.elements):Dt(this.elements,t.elements)}fromRotationTranslationScale(t,e,s,i,r){const n=Math.cos(t),h=Math.sin(t);return this.set(i*n,-r*h,0,i*h,r*n,0,e,s,1),this}getNormalMatrix(t){return Lt(this.elements,t.elements),this}copy(t){return Gt(this.elements,t.elements),this}clone(){return(new ps).copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}const fs=[];class bs extends gs{elements=new(Ne())(16);constructor(t=1,e=0,s=0,i=0,r=0,n=1,h=0,a=0,o=0,l=0,d=1,u=0,c=0,m=0,g=0,p=1){super();const f=this.elements;f[0]=t,f[1]=e,f[2]=s,f[3]=i,f[4]=r,f[5]=n,f[6]=h,f[7]=a,f[8]=o,f[9]=l,f[10]=d,f[11]=u,f[12]=c,f[13]=m,f[14]=g,f[15]=p}get x(){return this.elements[12]}get y(){return this.elements[13]}get z(){return this.elements[14]}get w(){return this.elements[15]}static get identity(){return(new bs).fromArray(kt([]))}set(t,e,s,i,r,n,h,a,o,l,d,u,c,m,g,p){return zt(this.elements,t,e,s,i,r,n,h,a,o,l,d,u,c,m,g,p),this}transpose(){return Wt(this.elements,this.elements),this}invert(t=this){return Vt(this.elements,t.elements),this}adjoint(t=this){return jt(this.elements,t.elements),this}determinant(){return Ht(this.elements)}add(t,e){return e?qt(this.elements,t.elements,e.elements):qt(this.elements,this.elements,t.elements),this}subtract(t,e){return e?$t(this.elements,t.elements,e.elements):$t(this.elements,this.elements,t.elements),this}multiply(t,e){return e?Yt(this.elements,t.elements,e.elements):Yt(this.elements,this.elements,t.elements),this}multiplyScalar(t=this,e){return Xt(this.elements,t.elements,e),this}premultiply(t,e){return e?Yt(this.elements,e.elements,t.elements):Yt(this.elements,t.elements,this.elements),this}translate(t){return Zt(this.elements,this.elements,t.elements),this}rotate(t){return Kt(this.elements,this.elements,t),this}scale(t){return Qt(this.elements,this.elements,t.elements),this}scaleScalar(t){return Qt(this.elements,this.elements,[t,t,t]),this}fromTranslation(t){return Jt(this.elements,t.elements),this}fromRotation(t,e){return te(this.elements,t,e),this}fromRotationX(t){return ee(this.elements,t),this}fromRotationY(t){return se(this.elements,t),this}fromRotationZ(t){return ie(this.elements,t),this}fromScale(t){return re(this.elements,t.elements),this}fromRotationTranslation(t,e){return ne(this.elements,t.elements,e.elements),this}fromPerspective(t,e,s,i){return he(this.elements,Fe(t),e,s,i),this}fromOrthogonal(t,e,s,i,r,n){return ae(this.elements,t,e,s,i,r,n),this}fromQuat(t){return oe(this.elements,t.elements),this}equals(t){return le(this.elements,t.value)}getRotation(t=new us){return de(fs,this.elements),t.set(fs[0],fs[1],fs[2],fs[3]),t}getScale(t=new cs){return ue(fs,this.elements),t.set(fs[0],fs[1],fs[2]),t}getTranslation(t=new cs){return ce(fs,this.elements),t.set(fs[0],fs[1],fs[2]),t}rotateX(t){return me(this.elements,this.elements,t),this}rotateY(t){return ge(this.elements,this.elements,t),this}rotateZ(t){return pe(this.elements,this.elements,t),this}compose(t,e,s){return fe(this.elements,e.elements,t.elements,s.elements),this}decompose(){return{rotation:this.getRotation(),scale:this.getScale(),translation:this.getTranslation()}}copy(t){return be(this.elements,t.elements),this}clone(){return(new bs).copy(this)}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class ws extends os{elements=new(Ne())(3);#o=[];#l="xyz";constructor(t=0,e=0,s=0,i="xyz"){super();const r=this.elements;r[0]=t,r[1]=e,r[2]=s,this.#l=i}get x(){return this.elements[0]}set x(t){this.elements[0]=t,this.triggerChange()}get y(){return this.elements[1]}set y(t){this.elements[1]=t,this.triggerChange()}get z(){return this.elements[2]}set z(t){this.elements[2]=t,this.triggerChange()}get order(){return this.#l}set order(t){this.#l=t,this.triggerChange()}get roll(){return this.x}set roll(t){this.x=t}get pitch(){return this.y}set pitch(t){this.y=t}get yaw(){return this.z}set yaw(t){this.z=t}fromObject({x:t,y:e,z:s,order:i}){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),void 0!==s&&(this.z=s),void 0!==i&&(this.order=i),this.triggerChange(),this}toObject(){return{x:this.x,y:this.y,z:this.z,order:this.order}}fromRotationMatrix(t,e=this.#l,s=!0){const i=t.toArray(),r=i[0],n=i[4],h=i[8],a=i[1],o=i[5],l=i[9],d=i[2],u=i[6],c=i[10];switch(e){case"xyz":this.y=Math.asin(Ce(h,-1,1)),Math.abs(h)<.9999999?(this.x=Math.atan2(-l,c),this.z=Math.atan2(-n,r)):(this.x=Math.atan2(u,o),this.z=0);break;case"yxz":this.x=Math.asin(-Ce(l,-1,1)),Math.abs(l)<.9999999?(this.y=Math.atan2(h,c),this.z=Math.atan2(a,o)):(this.y=Math.atan2(-d,r),this.z=0);break;case"zxy":this.x=Math.asin(Ce(u,-1,1)),Math.abs(u)<.9999999?(this.y=Math.atan2(-d,c),this.z=Math.atan2(-n,o)):(this.y=0,this.z=Math.atan2(a,r));break;case"zyx":this.y=Math.asin(-Ce(d,-1,1)),Math.abs(d)<.9999999?(this.x=Math.atan2(u,c),this.z=Math.atan2(a,r)):(this.x=0,this.z=Math.atan2(-n,o));break;case"yzx":this.z=Math.asin(Ce(a,-1,1)),Math.abs(a)<.9999999?(this.x=Math.atan2(-l,o),this.y=Math.atan2(-d,r)):(this.x=0,this.y=Math.atan2(h,c));break;case"xzy":this.z=Math.asin(-Ce(n,-1,1)),Math.abs(n)<.9999999?(this.x=Math.atan2(u,o),this.y=Math.atan2(h,r)):(this.x=Math.atan2(-l,c),this.y=0);break;default:throw new Error("Unknown Euler angle order")}return this.#l=e,s&&this.triggerChange(),this}fromQuaternion(t){const[e,s,i,r]=t.elements,n=s*s,h=-2*(n+i*i)+1,a=2*(e*s+r*i);let o=-2*(e*i-r*s);const l=2*(s*i+r*e),d=-2*(e*e+n)+1;o=o>1?1:o,o=o<-1?-1:o;const u=Math.atan2(l,d),c=Math.asin(o),m=Math.atan2(a,h);return new ws(u,c,m,"zyx")}fromVector3(t,e=this.#l){return this.set(t.x,t.y,t.z,e)}toQuaternion(){const t=Math.cos(.5*this.yaw),e=Math.sin(.5*this.yaw),s=Math.cos(.5*this.roll),i=Math.sin(.5*this.roll),r=Math.cos(.5*this.pitch),n=Math.sin(.5*this.pitch);return new us(t*i*r-e*s*n,t*s*n+e*i*r,e*s*r-t*i*n,t*s*r+e*i*n)}toVector3(){return new cs(this.x,this.y,this.z)}set(t,e,s,i=this.#l){return this.elements[0]=t,this.elements[1]=e,this.elements[2]=s,this.#l=i,this.triggerChange(),this}clone(){return(new ws).copy(this)}copy(t){let e=0;for(;e<this.elements.length;e++)this.elements[e]=t.elements[e];return this.#l=t.order,this.triggerChange(),this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.order===t.order}onChange(t){this.#o.includes(t)||this.#o.push(t)}triggerChange(){this.#o.forEach((t=>t()))}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}ye([function(t,e){var s={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},i={};for(var r in s)i[s[r]]=r;var n={};t.prototype.toName=function(e){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var r,h,a=i[this.toHex()];if(a)return a;if(null==e?void 0:e.closest){var o=this.toRgb(),l=1/0,d="black";if(!n.length)for(var u in s)n[u]=new t(s[u]).toRgb();for(var c in s){var m=(r=o,h=n[c],Math.pow(r.r-h.r,2)+Math.pow(r.g-h.g,2)+Math.pow(r.b-h.b,2));m<l&&(l=m,d=c)}return d}},e.string.push([function(e){var i=e.toLowerCase(),r="transparent"===i?"#0000":s[i];return r?new t(r).toRgb():null},"name"])}]);const xs=(t,e,s)=>{const i=We(t),r=s-e;let n=Ce(Number.parseFloat(`${t}`),e,s);return i&&(n=Number.parseInt(""+t*s,10)/100),Math.abs(n-s)<1e-6?1:t%r/r};class ys{r;g;b;a;constructor(t=255,e,s,i=1,r=!1){if(this.r=1,this.g=1,this.b=1,this.a=1,ze(e)&&ze(s))if(Ve(t)&&t<=255)this.setRGBA(t,t,t,this.a,r);else{const e=Ee(t).toRgb();e?this.setRGBA(e.r,e.g,e.b,e.a):console.error("Unsupported color value {".concat(String(t),"} provided"))}else this.setRGBA(t,e,s,i)}fromColor(t){const e=Ee(t).toRgb();return this.setRGBA(e.r,e.g,e.b,e.a)}fromHSL(t,e,s,i=1){const r=Ee({h:t,s:e,l:s,a:i}).toRgb();return this.setRGBA(r.r,r.g,r.b,r.a)}fromHSV(t,e,s,i=1){const r=Ee({h:t,s:e,v:s,a:i}).toRgb();return this.setRGBA(r.r,r.g,r.b,r.a)}setRGB(t,e,s){return this.setRGBA(t,e,s,this.a),this}setRGBA(t,e,s,i,r){return this.r=r?t:xs(t,0,255),this.g=r?e:xs(e,0,255),this.b=r?s:xs(s,0,255),this.setAlpha(i),this}setAlpha(t){return this.a=t>1?xs(t,0,255):t,this}toHex(){return Ee(this.toObject()).toHex()}toHSL(){return Ee(this.toObject()).toHsl()}toHSV(){return Ee(this.toObject()).toHsv()}toObject(t=!1){const e=t?1:255;return{r:this.r*e,g:this.g*e,b:this.b*e,a:this.a}}toArray(){return[this.r,this.g,this.b,this.a]}toVector(){return(new ms).fromArray(this.toArray())}toVector3(){return(new cs).fromArray(this.toArray())}toString(){return`${this.constructor.name}(${this.r}, ${this.g}, ${this.b}, ${this.a})`}}class Es extends bs{frustum(t,e,s,i,r,n,h){return we(t.elements,e,s,r,i,n,h),this}orthographic(t,e,s,i,r,n){return ae(this.elements,t,e,i,s,r,n),this}perspective(t,e,s,i){return he(this.elements,t,e,s,i),this}lookAt(t,e=new cs(0,0,0),s=new cs(0,1,0)){return xe(this.elements,t.elements,e.elements,s.elements),this}toString(){return`${this.constructor.name}(${this.elements.join(", ")})`}}class As{visible;localMatrix;worldMatrix;matrixAutoUpdate;position;scale;rotation;quaternion;up;children;parent;worldMatrixNeedsUpdate;constructor(){this.visible=!0,this.localMatrix=new Es,this.worldMatrix=new Es,this.matrixAutoUpdate=!0,this.position=new cs,this.scale=new cs(1,1,1),this.rotation=new ws,this.quaternion=new us,this.up=new cs(0,1,0),this.parent=null,this.children=[],this.worldMatrixNeedsUpdate=!1,this.rotation.onChange((()=>{this.quaternion.fromEuler(this.rotation)})),this.quaternion.onChange((()=>{this.rotation.fromQuaternion(this.quaternion)}))}add(t,e=!0){this.contains(t)||this.children.push(t),e&&t.setParent(this,!1)}remove(t,e=!0){this.contains(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}contains(t){return this.children.includes(t)}setParent(t,e=!0){this.parent&&t!==this.parent&&this.parent.remove(this,!1),this.parent=t,e&&t&&t.add(this,!1)}traverse(t){if(!t(this))for(let e=0,s=this.children.length;e<s;e++)this.children[e].traverse(t)}lookAt(t,e){e?this.localMatrix.lookAt(this.position,t,this.up):this.localMatrix.lookAt(t,this.position,this.up),this.localMatrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}updateMatrixWorld(t){let e=t;this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||e)&&(null===this.parent?this.worldMatrix.copy(this.localMatrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.localMatrix),this.worldMatrixNeedsUpdate=!1,e=!0);for(let t=0,s=this.children.length;t<s;t++){this.children[t].updateMatrixWorld(e)}}updateMatrix(){this.localMatrix.compose(this.position,this.quaternion,this.scale),this.worldMatrixNeedsUpdate=!0}decompose(){this.localMatrix.getTranslation(this.position),this.localMatrix.getRotation(this.quaternion),this.localMatrix.getScale(this.scale),this.rotation.fromQuaternion(this.quaternion)}clone(){return(new As).copy(this,!1)}copy(t,e){if(this.visible=t.visible,this.position.copy(t.position),this.scale.copy(t.scale),this.rotation.copy(t.rotation),this.quaternion.copy(t.quaternion),this.up.copy(t.up),this.localMatrix.copy(t.localMatrix),this.worldMatrix.copy(t.worldMatrix),this.matrixAutoUpdate=t.matrixAutoUpdate,e)for(let e=0,s=t.children.length;e<s;e++){const s=t.children[e];this.add(s.clone())}return this}}class Ts{renderer;constructor(t){this.renderer=t}get gl(){return this.renderer.gl}get rendererState(){return this.renderer.state}}class vs{id;data;type;size;instanced;stride;offset;divisor;normalized;needsUpdate;count;usage;target;buffer;constructor(t,e){const s=Object.assign({},{size:1,normalized:!0,stride:0,offset:0,divisor:0,usage:t.gl.STATIC_DRAW},e);if(this.id=Ye("attribute"),this.needsUpdate=!1,!e.data||Array.isArray(e.data))throw new TypeError("BufferAttribute: data should be a typed array");var i,r;this.data=s.data,this.size=s.size||1,this.type=s.type||(i=t.gl,(r=s.data)instanceof Float32Array||r instanceof Float64Array?i.FLOAT:r instanceof Uint16Array?i.UNSIGNED_SHORT:r instanceof Uint8Array||r instanceof Uint8ClampedArray?i.UNSIGNED_BYTE:r instanceof Uint32Array?i.UNSIGNED_INT:r instanceof Int8Array?i.BYTE:r instanceof Int16Array?i.SHORT:r instanceof Int32Array?i.INT:void 0),this.normalized=s.normalized||!1,this.stride=s.stride||0,this.offset=s.offset||0,this.divisor=s.divisor||0,this.instanced=s.divisor>0,this.usage=s.usage||t.gl.STATIC_DRAW,s.target&&(this.target=s.target);let n=s.count;void 0!==s.count&&null!==s.count||(n=s.stride?s.data.byteLength/s.stride:s.data.length/s.size),this.count=n}}const _s=new cs;class Ms extends Ts{#d;#u;#c;#m;drawRange;instancedCount;isInstanced;drawMode;constructor(t,e={}){super(t),this.drawRange={start:0,count:0},this.instancedCount=0,this.isInstanced=!1,this.#u=new Map,this.#c=new Map,this.#d=Ye("geometry"),this.drawMode=this.gl.TRIANGLES,t.bindVertexArray(null),t.state.setActiveGeometry(null);for(const t in e){const s=e[t];if(s instanceof vs)"index"===t?this.setIndex(s):this.addAttribute(t,s);else if(s.data){const e=new vs(this.renderer,s);"index"===t?this.setIndex(e):this.addAttribute(t,e)}}}get id(){return this.#d}get attributes(){return this.#u}get attributesData(){const t={},e=this.#u.entries();for(let s=0;s<this.#u.size;s++){const s=e.next().value;t[s[0]]=Xe(s[1],["id","buffer"])}return t}get index(){return this.attributes.get("index")}get bounds(){return this.#m}set bounds(t){this.#m=t}addAttribute(t,e){if(e.target||(e.target="index"===t?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER),e.needsUpdate=!1,this.attributes.set(t,e),e.buffer||(e.buffer=this.gl.createBuffer(),this.updateAttribute(e)),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor),console.warn(`Geometry has multiple instanced buffers of different length - instancedCount: ${this.instancedCount}, count: ${e.count}, divisor: ${e.divisor}, attribute: ${t}`);this.instancedCount=e.count*e.divisor}else"index"===t?this.drawRange.count=e.count:this.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}getAttribute(t){return this.attributes.get(t)}setAttributeData(t,e){const s=this.getAttribute(t);s&&(s.data=e,s.needsUpdate=!0)}updateAttribute(t){!t.buffer&&(t.buffer=this.gl.createBuffer()),this.rendererState.boundBuffer!==t.buffer&&(this.gl.bindBuffer(t.target,t.buffer),this.rendererState.boundBuffer=t.buffer),this.gl.bufferData(t.target,t.data,t.usage),t.needsUpdate=!1}removeAttribute(t){this.attributes.delete(t)}setIndex(t){if(t instanceof vs)t.size=1,this.addAttribute("index",t);else{const e=new vs(this.renderer,{data:t.length>65535?new Uint32Array(t):new Uint16Array(t),size:1});this.addAttribute("index",e)}this.drawRange.count=this.index?.count}setVertices(t){const e=[],s=t.length;for(let i=0;i<s;i++){const s=t[i];e.push(s[0],s[1],s[2])}this.addAttribute("position",new vs(this.renderer,{data:new Float32Array(e),size:3}))}setNormals(t){this.addAttribute("normal",new vs(this.renderer,{data:new Float32Array(t),size:2}))}setUVs(t){this.addAttribute("uv",new vs(this.renderer,{data:new Float32Array(t),size:2}))}setColors(t){const e=[];for(let s=0;s<t.length;s++){let i=t[s];i&&(i instanceof cs||i instanceof ms)&&(i=i.toArray()),e.push(i[0],i[1],i[2],i[3]||1)}this.addAttribute("color",new vs(this.renderer,{data:new Float32Array(e),size:4}))}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){const{attributeOrder:e}=t,s=this.renderer.createVertexArray();this.renderer.bindVertexArray(s),this.#c.set(e,s),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach(((t,{name:e,type:s})=>{const i=this.attributes.get(e);if(!i)return;this.gl.bindBuffer(i.target,i.buffer),this.rendererState.boundBuffer=i.buffer;let r=1;s===this.gl.FLOAT_MAT2&&(r=2),s===this.gl.FLOAT_MAT3&&(r=3),s===this.gl.FLOAT_MAT4&&(r=4);const n=i.size/r,h=1===r?0:r*r*r,a=1===r?0:r*r;for(let e=0;e<r;e++){const s=t+e;this.gl.vertexAttribPointer(s,n,i.type,i.normalized,i.stride+h,i.offset+a),this.gl.enableVertexAttribArray(s),this.renderer.vertexAttribDivisor(s,i.divisor)}}));const e=this.attributes.get("index");e&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,e.buffer)}computeBoundingBox(t){const{data:e,offset:s=0,stride:i,size:r}=this.attributes.get("position");this.#m||(this.#m={min:new cs,max:new cs,center:new cs,scale:new cs,radius:Number.POSITIVE_INFINITY}),this.#m.min.setScalar(+Number.POSITIVE_INFINITY),this.#m.max.setScalar(Number.NEGATIVE_INFINITY);const n=t||e,h=i||r;for(let t=s;t<n.length;t+=h){const e=n[t+0],s=n[t+1],i=n[t+2];this.#m.min.x=Math.min(e,this.#m.min.x),this.#m.min.y=Math.min(s,this.#m.min.y),this.#m.min.z=Math.min(i,this.#m.min.z),this.#m.max.x=Math.max(e,this.#m.max.x),this.#m.max.y=Math.max(s,this.#m.max.y),this.#m.max.z=Math.max(i,this.#m.max.z)}return this.#m.scale.subVectors(this.#m.max,this.#m.min),this.#m.center.add(this.#m.min).add(this.#m.max).divideScalar(2),this.#m}computeBoundingSphere(t){const{data:e,offset:s=0,stride:i,size:r}=this.attributes.get("position");this.#m||this.computeBoundingBox(t);const n=t||e;let h=0;const a=i||r,o=n.length;for(let t=s;t<o;t+=a)_s.fromArray(n,t),h=Math.max(h,this.#m.center.distanceToSquared(_s));this.#m.radius=Math.sqrt(h)}draw(t,e=this.drawMode){const{start:s,count:i}=this.drawRange,r=`${this.id}_${t.attributeOrder}`;if(this.rendererState.activeGeometryId!==r){this.#c.get(t.attributeOrder)||this.createVAO(t),this.renderer.bindVertexArray(this.#c.get(t.attributeOrder)),this.rendererState.activeGeometryId=r}if(t.attributeLocations.forEach(((t,{name:e})=>{const s=this.getAttribute(e);s&&s.needsUpdate&&this.updateAttribute(s)})),this.isInstanced)if(this.index){const t=this.index.offset+2*s;this.renderer.drawElementsInstanced(e,i,this.index.type,t,this.instancedCount)}else this.renderer.drawArraysInstanced(e,s,i,this.instancedCount);else if(this.index){const t=this.index.offset+2*s;this.gl.drawElements(e,i,this.index.type,t)}else this.gl.drawArrays(e,s,i)}copy(t){const e=t.attributesData;for(const t in e){const s=e[t];if(s instanceof vs)"index"===t?this.setIndex(s):this.addAttribute(t,s);else if(s.data){const e=new vs(this.renderer,s);"index"===t?this.setIndex(e):this.addAttribute(t,e)}}return t.bounds&&(this.bounds={min:(new cs).copy(t.bounds.min),max:(new cs).copy(t.bounds.max),center:(new cs).copy(t.bounds.center),scale:(new cs).copy(t.bounds.scale),radius:t.bounds.radius}),this}clone(){const t=new Ms(this.renderer,{}).copy(this);return t.drawMode=this.drawMode,t}destroy(){this.#c.forEach((t=>{this.renderer.deleteVertexArray(t)})),this.#c.clear(),this.#u.forEach((t=>{this.gl.deleteBuffer(t.buffer)})),this.#u.clear()}}class Ss extends As{gl;modelViewMatrix;normalMatrix;renderOrder;zDepth;frustumCulled;mode;renderer;#d;#g;#p;#f;#b;#w;constructor(t,e={}){super();const s=Object.assign({},{mode:t.gl.TRIANGLES,frustumCulled:!0,renderOrder:0},e);this.renderer=t,this.gl=this.renderer.gl,this.modelViewMatrix=new bs,this.normalMatrix=new ps,this.renderOrder=s.renderOrder,this.frustumCulled=s.frustumCulled,this.zDepth=0,this.#d=s.id||Ye("mesh"),this.#p=s.geometry,this.#f=s.program,this.#b=Boolean(s.wireframe),this.mode=s.mode,this.#g=s.mode,this.#b&&(this.mode=this.gl.LINES,this.updateWireframeGeometry(this.#b))}get id(){return this.#d}get geometry(){return this.#b?this.#w:this.#p}get program(){return this.#f}set wireframe(t){this.mode=t?this.gl.LINES:this.#g,this.#b=t,this.updateWireframeGeometry(this.#b)}get wireframe(){return this.#b}draw(t={}){const{camera:e,target:s}=t,i={};e?(Object.assign(i,{projectionMatrix:e.projectionMatrix,cameraPosition:e.worldPosition,viewMatrix:e.viewMatrix}),this.modelViewMatrix.multiply(e.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix)):this.modelViewMatrix.copy(this.worldMatrix),Object.assign(i,{resolution:new ls(this.renderer.state?.viewport?.width||1,this.renderer.state?.viewport?.height||1),modelMatrix:this.worldMatrix,modelViewMatrix:this.modelViewMatrix,normalMatrix:this.normalMatrix}),Object.keys(i).forEach((t=>{Object.hasOwn(this.program.uniforms,t)||(this.program.uniforms[t]={value:null}),this.program.uniforms[t].value=i[t]})),s&&s.bind(),this.program.use(),this.geometry.draw(this.program,this.mode),s&&s.unbind()}updateWireframeGeometry(t,e=!1){if(this.#p&&(e||!this.#w)){this.#w&&this.#w.destroy();const t=this.#p.attributes.get("position")?.data,e=this.#p.index?.data,s=e?e.length:Math.floor(t.length/3),i=[];this.#p.index?e&&ve(t,i,s,e):ve(t,i,s);const r=i.length>65536?new Uint32Array(i):new Uint16Array(i);this.#w=new Ms(this.renderer,{...this.#p.attributesData,index:{data:r}})}}updateGeometry(t,e=!0){e&&this.#p&&this.#p.destroy(),this.#p=t,this.updateWireframeGeometry(this.#b,!0)}updateProgram(t,e=!0){e&&this.#f&&this.#f.destroy(),this.#f=t}destroy(){this.program.destroy(),this.geometry.destroy()}clone(){return new Ss(this.gl,{geometry:this.geometry,program:this.program,frustumCulled:this.frustumCulled,mode:this.mode,renderOrder:this.renderOrder}).copy(this)}copy(t,e=!0){return super.copy(t,e),this.modelViewMatrix.copy(t.modelViewMatrix),this.normalMatrix.copy(t.normalMatrix),this.mode=t.mode,this.renderOrder=t.renderOrder,this.zDepth=t.zDepth,this}}class Fs extends As{clone(){return(new Fs).copy(this,!1)}copy(t,e){return super.copy(t,e),this.matrixAutoUpdate=t.matrixAutoUpdate,this}}var Rs=(t=>(t[t.NoBlending=0]="NoBlending",t[t.NormalBlending=1]="NormalBlending",t[t.AdditiveBlending=2]="AdditiveBlending",t[t.SubtractiveBlending=3]="SubtractiveBlending",t[t.MultiplyBlending=4]="MultiplyBlending",t[t.CustomBlending=5]="CustomBlending",t))(Rs||{});class Cs extends Ts{#x;constructor(t,e){super(t);const{gl:s}=t;this.#x={viewport:{x:0,y:0,width:0,height:0}},this.apply(e||{frontFace:s.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:s.LESS,blending:1,blendFunc:{src:s.ONE,dst:s.ZERO},blendEquation:{modeRGB:s.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new ys(0),stencil:{func:{},opFront:{},opBack:{}}})}get state(){return this.#x}get viewport(){return this.#x.viewport}get textureUnits(){return this.#x.textureUnits}get activeTextureUnit(){return this.#x.activeTextureUnit}set activeTextureUnit(t){this.#x.activeTextureUnit=t}get currentProgramId(){return this.#x.currentProgramId}set currentProgramId(t){this.#x.currentProgramId=t}get activeGeometryId(){return this.#x.activeGeometryId}set activeGeometryId(t){this.#x.activeGeometryId=t}set flipY(t){this.#x.flipY=t}get flipY(){return this.#x.flipY}set unpackAlignment(t){this.#x.unpackAlignment=t}get unpackAlignment(){return this.#x.unpackAlignment}set premultiplyAlpha(t){this.#x.premultiplyAlpha=t}get premultiplyAlpha(){return this.#x.premultiplyAlpha}set boundBuffer(t){this.#x.boundBuffer=t}get boundBuffer(){return this.#x.boundBuffer}set anisotropy(t){this.#x.anisotropy=t}get anisotropy(){return this.#x.anisotropy}apply(t){if(void 0!==t.blending&&null!==t.blending)this.setBlending(t.blending,t);else{if(t.blendFunc){const{src:e,dst:s,srcAlpha:i,dstAlpha:r}=t.blendFunc;this.setBlendFunc(e,s,i,r),this.enable(this.gl.BLEND)}else this.disable(this.gl.BLEND);if(t.blendEquation){const{modeRGB:e,modeAlpha:s}=t.blendEquation;this.setBlendEquation(e,s)}}ze(t.cullFace)||He(t.cullFace)||this.setCullFace(t.cullFace),ze(t.frontFace)||He(t.frontFace)||this.setFrontFace(t.frontFace),t.depthTest?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST),ze(t.depthMask)||He(t.depthMask)||this.setDepthMask(t.depthMask),ze(t.depthWrite)||He(t.depthWrite)||this.setDepthMask(t.depthWrite),ze(t.depthFunc)||He(t.depthFunc)||this.setDepthFunc(t.depthFunc),ze(t.lineWidth)||He(t.lineWidth)||this.setLineWidth(t.lineWidth),this.#x=Object.assign(this.#x,t)}enable(t){!0!==this.#x[t]&&(this.gl.enable(t),this.#x[t]=!0)}disable(t){!1!==this.#x[t]&&(this.gl.disable(t),this.#x[t]=!1)}setViewport(t,e,s=0,i=0){this.#x.viewport.width===t&&this.#x.viewport.height===e||(this.gl.viewport(s,i,t,e),this.#x.viewport={width:t,height:e,x:s,y:i})}setMask(t){this.#x.colorMask!==t&&(this.gl.colorMask(t,t,t,t),this.#x.colorMask=t)}setBlending(t,e){if(this.#x.blending=t,0!==t)if(this.enable(this.gl.BLEND),2===t)this.#x.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE,this.gl.ONE,this.gl.ONE)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE));else if(3===t)this.#x.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR));else if(4===t)this.#x.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR,this.gl.ZERO,this.gl.SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ZERO,this.gl.SRC_COLOR));else if(1===t)this.#x.premultiplyAlpha?(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)):(this.setBlendEquation(this.gl.FUNC_ADD,this.gl.FUNC_ADD),this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));else if(5===t){if(e?.blendFunc){const{src:t,dst:s,srcAlpha:i,dstAlpha:r}=e.blendFunc;this.setBlendFunc(t,s,i,r),this.enable(this.gl.BLEND)}if(e?.blendEquation){const{modeRGB:t,modeAlpha:s}=e.blendEquation;this.setBlendEquation(t,s)}}else console.error("State: Invalid blending: ",t);else this.disable(this.gl.BLEND)}setBlendFunc(t,e,s,i){t===this.#x.blendFunc?.src&&e===this.#x.blendFunc?.dst&&s===this.#x.blendFunc?.srcAlpha&&i===this.#x.blendFunc?.dstAlpha||(this.#x.blendFunc={src:t,dst:e,srcAlpha:s,dstAlpha:i},ze(s)||He(s)||ze(i)||He(i)?this.gl.blendFunc(t,e):this.gl.blendFuncSeparate(t,e,s,i))}setBlendEquation(t,e){t===this.#x.blendEquation?.modeRGB&&e===this.#x.blendEquation?.modeAlpha||(this.#x.blendEquation={modeRGB:t,modeAlpha:e},ze(e)||He(e)?this.gl.blendEquation(t):this.gl.blendEquationSeparate(t,e))}setClearAlpha(t){this.#x.clearAlpha!==t&&(this.#x.clearAlpha=t)}setClearColor(t,e){this.#x.clearAlpha===e&&this.#x.clearColor===t||(this.#x.clearColor=t,ze(e)||He(e)?this.#x.clearAlpha=t.a:this.#x.clearAlpha=e,this.gl.clearColor(t.r,t.g,t.b,this.#x.clearAlpha))}setCullFace(t){this.#x.cullFace!==t&&(t?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.#x.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.#x.frontFace!==t&&(this.#x.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.#x.depthMask!==t&&(this.#x.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.#x.depthFunc!==t&&(this.#x.depthFunc=t,this.gl.depthFunc(t))}setDepthTest(t){this.#x.depthTest!==t&&(this.#x.depthTest=t,t?this.enable(this.gl.DEPTH_TEST):this.disable(this.gl.DEPTH_TEST))}setStencilFunc(t,e,s,i){this.#x?.stencil?.func?.cmp===t&&this.#x?.stencil?.func?.ref===e&&this.#x?.stencil?.func?.mask===s||(this.#x?.stencil||(this.#x.stencil={}),this.#x?.stencil?.func||(this.#x.stencil.func={}),this.#x.stencil.func={ref:e,mask:s,cmp:t},i?this.gl.stencilFuncSeparate(i,t,e,s):this.gl.stencilFunc(t,e,s))}setStencilOp(t,e,s,i){return this.#x?.stencil||(this.#x.stencil={}),i&&i!==this.gl.FRONT_AND_BACK?i===this.gl.FRONT?this.#x.stencil?.opFront?.fail!==t||this.#x.stencil?.opFront?.zFail!==e||this.#x.stencil?.opFront?.zPass!==s:i===this.gl.BACK?this.#x.stencil?.opBack?.fail!==t||this.#x.stencil?.opBack?.zFail!==e||this.#x.stencil?.opBack?.zPass!==s:void 0:this.#x.stencil?.opFront?.fail!==t||this.#x.stencil?.opFront?.zFail!==e||this.#x.stencil?.opFront?.zPass!==s||this.#x.stencil?.opBack?.fail!==t||this.#x.stencil?.opBack?.zFail!==e||this.#x.stencil?.opBack?.zPass!==s}setStencilMask(t,e){this.#x.stencil?.mask!==t&&(this.#x.stencil={...this.#x.stencil,mask:t},e?this.gl.stencilMaskSeparate(e,t):this.gl.stencilMask(t))}setActiveTexture(t){this.#x.activeTextureUnit!==t&&(this.#x.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}setLineWidth(t){this.#x.lineWidth!==t&&(this.#x.lineWidth=t,this.gl.lineWidth(t))}setPolygonOffset(t,e,s){t?(this.enable(this.gl.POLYGON_OFFSET_FILL),this.#x.polygonOffsetFactor===e&&this.#x.polygonOffsetUnits===s||(this.gl.polygonOffset(e,s),this.#x.polygonOffsetFactor=e,this.#x.polygonOffsetUnits=s)):this.disable(this.gl.POLYGON_OFFSET_FILL)}bindFramebuffer(t={}){const{target:e=this.gl.FRAMEBUFFER,buffer:s=null}=t;this.#x.framebuffer!==s&&(this.#x.framebuffer=s,this.gl.bindFramebuffer(e,s))}setActiveGeometry(t){this.#x.activeGeometryId=t}reset(t=!0){const e=Object.keys(this.#x);t?(e.filter((t=>["viewport","premultiplyAlpha"].indexOf(t)<0)).forEach((t=>{delete this.#x[t]})),this.bindFramebuffer({buffer:null}),this.apply({frontFace:this.gl.CCW,depthTest:!1,depthWrite:!0,depthMask:!0,depthFunc:this.gl.LESS,blending:1,blendFunc:{src:this.gl.ONE,dst:this.gl.ZERO},blendEquation:{modeRGB:this.gl.FUNC_ADD},premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,framebuffer:null,textureUnits:[],activeTextureUnit:-1,activeGeometryId:-1,currentProgramId:-1,clearAlpha:1,clearColor:new ys(0),stencil:{func:{},opFront:{},opBack:{}}})):(e.filter((t=>["flipY","framebuffer","textureUnits","activeTextureUnit","activeGeometryId","currentProgramId"].indexOf(t)>-1)).forEach((t=>{delete this.#x[t]})),this.bindFramebuffer({buffer:null}),this.#x.flipY=!1,this.#x.activeGeometryId=-1,this.#x.activeTextureUnit=-1,this.#x.currentProgramId=-1,this.#x.textureUnits=[],this.#x.boundBuffer=null)}}const Os=["WEBGL_depth_texture","OES_texture_half_float","OES_texture_float","OES_standard_derivatives","OES_element_index_uint","EXT_frag_depth","EXT_blend_minmax","EXT_shader_texture_lod","WEBGL_draw_buffers","WEBGL_color_buffer_float"],Bs=["EXT_color_buffer_float"],Ls=["WEBGL_lose_context","OES_texture_half_float_linear","OES_texture_float_linear","EXT_color_buffer_half_float","WEBGL_debug_renderer_info","EXT_texture_filter_anisotropic"];class Ns{#y;#x;#E;#A;#T;#v;#_;#M;#S;#F;#R;#C;#O;vertexAttribDivisor;drawArraysInstanced;drawElementsInstanced;createVertexArray;bindVertexArray;deleteVertexArray;width;height;constructor(t,e={}){const s=Object.assign({},{autoClear:!0,depth:!0,alpha:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,requestWebGl2:!0,extensions:[]},e);this.#A=Boolean(s.autoClear),this.#T=s.depth,this.#v=s.alpha,this.#_=s.stencil,this.#M=s.antialias,this.#S=s.premultipliedAlpha,this.#F=s.preserveDrawingBuffer,this.#y=Ue(t)||Ie(t)?t:Pe(t,{alpha:this.#v,depth:this.#T,stencil:this.#_,antialias:this.#M,powerPreference:s.powerPreference,premultipliedAlpha:this.#S,preserveDrawingBuffer:this.#F},s.requestWebGl2);const i=this.#y?.getContextAttributes(),r=this.#y?.getParameter(this.#y.VIEWPORT),n=this.#y?.getParameter(this.#y.UNPACK_FLIP_Y_WEBGL);this.#x=new Cs(this),i&&(this.#T=Boolean(i.depth),this.#M=Boolean(i.antialias),this.#v=Boolean(i.alpha),this.#_=Boolean(i.stencil),this.#S=Boolean(i.premultipliedAlpha),this.#F=Boolean(i.preserveDrawingBuffer)),this.#x.flipY=Boolean(n),this.#x.setViewport(r[2],r[3],r[0],r[1]),this.#x.premultiplyAlpha=this.#S,this.#R=!0,this.#C=s.dpr||1,this.width=this.gl.canvas.width/this.#C,this.height=this.gl.canvas.height/this.#C,this.#O=!!s.frustumCull,this.#E={},this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),s.extensions&&(s.extensions.filter((t=>Os.findIndex((e=>e===t))>-1)).forEach((t=>{this.#E[t]||this.isWebGL2||(this.#E[t]=this.gl.getExtension(t))})),s.extensions.filter((t=>Bs.findIndex((e=>e===t))>-1)).forEach((t=>{!this.#E[t]&&this.isWebGL2&&(this.#E[t]=this.gl.getExtension(t))})),s.extensions.filter((t=>Ls.findIndex((e=>e===t))>-1)).forEach((t=>{this.#E[t]||(this.#E[t]=this.gl.getExtension(t))})))}get gl(){return this.#y}get attributes(){return{dpr:this.#C,flipY:this.#x.flipY,depth:this.#T,color:this.#R,antialias:this.#M,alpha:this.#v,stencil:this.#_,autoClear:this.#A,frustumCull:this.#O,premultipliedAlpha:this.#S,preserveDrawingBuffer:this.#F}}get canvas(){return this.#y.canvas}get isWebGL(){return Ue(this.gl)}get isWebGL2(){return Ie(this.gl)}get extensions(){return this.#E}extension(t){return this.#E[t]}get size(){return{width:"clientWidth"in this.canvas?this.canvas.clientWidth:this.canvas.width,height:"clientHeight"in this.canvas?this.canvas.clientHeight:this.canvas.height}}get state(){return this.#x}get premultipliedAlpha(){return this.#S}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.#C,this.gl.canvas.height=e*this.#C}setViewport(t,e,s=0,i=0){this.#x.setViewport(t,e,s,i)}getExtension(t,e,s){const i=this.gl[e];if(e&&i)return i.bind(this.gl);this.#E[t]||(this.#E[t]=this.gl.getExtension(t));const r=this.#E[t];return e?r?r[s].bind(r):null:r}getRenderList({scene:t,camera:e}){const s=[];return t.traverse((t=>{if(!t.visible)return!0;t.draw&&(this.#O&&t.frustumCulled&&e&&!e.frustumIntersectsMesh(t)||s.push(t))})),s}render(t){const{scene:e,camera:s,target:i=null,update:r=!0,clear:n}=t;null===i?(this.#x.bindFramebuffer({buffer:null}),this.setViewport(this.width*this.#C,this.height*this.#C)):(i.bind(),this.setViewport(i.width,i.height)),(n||this.#A&&!1!==n)&&(!this.#T||i&&!i.depth||(this.#x.enable(this.gl.DEPTH_TEST),this.#x.setDepthMask(!0)),this.clear(this.#R,this.#T,this.#_)),r&&e.updateMatrixWorld(),s&&s.updateMatrixWorld();const h=this.getRenderList({scene:e,camera:s});let a=0;const o=h.length;for(;a<o;a++){h[a].draw({camera:s})}i&&i.unbind()}clear(t=this.#R,e=this.#T,s=this.#_){let i=0;t&&(i|=this.gl.COLOR_BUFFER_BIT),e&&(i|=this.gl.DEPTH_BUFFER_BIT),s&&(i|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(i)}resetState(t=!0,e=null){this.#x.reset(t),this.bindVertexArray(e)}}const Us="Resource subclass must define virtual methods";class Is extends Ts{#B;#L;id;name;userData;byteLength;options;constructor(t,e={}){super(t),this.id=e?.id||Ye(this.constructor.name),this.name=e?.name,this.userData=e?.userData,this.#B=e?.handle,this.options=e,void 0===this.#B&&(this.#B=this.createHandle()),this.byteLength=0}get handle(){return this.#B}swapHandle(t){this.#L=this.#B,this.#B=t}restoreHandle(){this.#B=this.#L}destroy(){this.delete()}delete({deleteChildren:t=!1}={}){const e=this.handle&&this.deleteHandle(this.handle);return this.handle&&this.removeStats(),this.#B=null,e&&t&&e.filter(Boolean).forEach((t=>t.delete())),this}bind(t=this.handle){throw new Error(Us)}unbind(){this.bind(null)}removeStats(){throw new Error(Us)}createHandle(){throw new Error(Us)}deleteHandle(){throw new Error(Us)}toString(){return`${this.constructor.name}(${this.id})`}}class Ps extends Is{width;height;#N;constructor(t,e={}){super(t,{...e,format:e.format||t.gl.DEPTH_COMPONENT16}),this.#N=this.options.format,this.width=this.options.width,this.height=this.options.height,console.assert(this.width>0&&this.height>0,"Renderbuffer object requires valid width and height greater than zero"),this.bind(),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,this.#N,this.width,this.height)}resize(t,e){t===this.width&&e===this.height||(this.width=t,this.height=e,this.bind(),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.#N,t,e),this.unbind())}bind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.handle)}unbind(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}removeStats(){}destroy(){this.unbind(),this.deleteHandle()}createHandle(){return this.gl.createRenderbuffer()}deleteHandle(){this.handle&&this.gl.deleteRenderbuffer(this.handle)}}const Ds=new Uint8Array(4);class Gs extends Is{needsUpdate=!1;textureUnit=0;image;width;height;target;#x={};constructor(t,e={},s=!0){const{gl:i}=t,r={target:i.TEXTURE_2D,type:i.UNSIGNED_BYTE,format:i.RGBA,internalFormat:e.format||i.RGBA,wrapS:i.CLAMP_TO_EDGE,wrapT:i.CLAMP_TO_EDGE,generateMipmaps:!0,minFilter:i.LINEAR,magFilter:i.LINEAR,premultiplyAlpha:!1,unpackAlignment:4,anisotropy:0,flipY:!1,level:0};super(t,Object.assign({},r,e)),this.textureUnit=0,this.image=this.options.image,this.width=this.options.width,this.height=this.options.height,this.target=this.options.target,this.#x.version=-1,this.needsUpdate=Boolean(s),this.needsUpdate&&this.update()}setData(t,e=this.width,s=this.height){this.image=t,this.width=e,this.height=s,this.needsUpdate=!0}setOptions(t){this.options=Object.assign(this.options,t),this.width=this.options.width,this.height=this.options.height,this.needsUpdate=!0}fromSrc(t){return new Promise(((e,s)=>{const i=new Image;i.onload=()=>{this.setData(i,i.width,i.height),e(this)},i.onerror=t=>{s(t)},i.crossOrigin="*",i.src=t}))}update(t=0){const e=!(this.image===this.#x.image&&!this.needsUpdate);if((e||this.rendererState.textureUnits[t]!==this.id||this.rendererState.activeTextureUnit!==t)&&(this.rendererState.setActiveTexture(t),this.bind(t)),e){if(this.needsUpdate=!1,this.options.wrapS!==this.#x.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.options.wrapS),this.#x.wrapS=this.options.wrapS),this.options.wrapT!==this.#x.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.options.wrapT),this.#x.wrapT=this.options.wrapT),this.options.minFilter!==this.#x.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.options.minFilter),this.#x.minFilter=this.options.minFilter),this.options.magFilter!==this.#x.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.options.magFilter),this.#x.magFilter=this.options.magFilter),this.options.flipY!==this.rendererState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.options.flipY),this.rendererState.flipY=this.options.flipY),this.options.premultiplyAlpha!==this.rendererState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha),this.rendererState.premultiplyAlpha=this.options.premultiplyAlpha),this.options.unpackAlignment!==this.rendererState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.options.unpackAlignment),this.rendererState.unpackAlignment=this.options.unpackAlignment),this.options.anisotropy&&this.options.anisotropy!==this.rendererState.anisotropy){const t=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(t){const e=this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT);let s=this.options.anisotropy;this.options.anisotropy>e&&(s=e,console.warn(`[Texture]: Texture.anisotropy option exceeded the maximum allowed value ${e} of the device`)),this.gl.texParameterf(this.target,t.TEXTURE_MAX_ANISOTROPY_EXT,s)}this.rendererState.anisotropy=this.options.anisotropy}this.image?(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.renderer.isWebGL2&&Ve(this.options.offset)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image,this.options.offset):ArrayBuffer.isView(this.image)?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.image):this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.options.format,this.options.type,this.image),this.options.generateMipmaps&&(this.renderer.isWebGL2||Oe(this.image.width)&&Oe(this.image.height)?this.gl.generateMipmap(this.target):(this.options.generateMipmaps=!1,this.options.wrapS=this.gl.CLAMP_TO_EDGE,this.options.wrapT=this.options.wrapS,this.options.minFilter=this.gl.LINEAR))):this.renderer.isWebGL2&&Ve(this.options.offset)?this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,this.options.offset):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Ds,this.options.offset):this.width>0?this.gl.texImage2D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,0,this.options.format,this.options.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Ds),this.#x.image=this.image,this.#x.version+=1}}bind(t=this.textureUnit){this.rendererState.textureUnits[this.rendererState.activeTextureUnit]!==this.id&&(this.textureUnit=t,this.rendererState.textureUnits[this.textureUnit]=this.id,this.gl.bindTexture(this.target,this.handle))}unbind(){this.gl.activeTexture(this.gl.TEXTURE0+this.textureUnit),this.gl.bindTexture(this.target,null),delete this.rendererState.textureUnits[this.textureUnit]}destroy(){this.unbind(),super.destroy()}removeStats(){this.#x={version:-1}}createHandle(){return this.gl.createTexture()}deleteHandle(){this.handle&&this.gl.deleteTexture(this.handle)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}}class ks extends Gs{needsUpdate=!0;constructor(t,e={}){super(t,{...e,image:e.data,premultiplyAlpha:!0,flipY:!1,unpackAlignment:1})}}class zs extends Is{#U;#I;depth;width;height;viewport;drawBuffersChanged;drawBuffers;#P;#D;#G;constructor(t,e={}){super(t,{color:1,depth:!0,depthTexture:!1,stencil:!1,...e}),this.#I=new Map,this.#U=new Map,this.depth=Boolean(e.depth),this.drawBuffers=[],this.drawBuffersChanged=!1,this.width=this.options.width,this.height=this.options.height,this.viewport=new ms(0,0,this.width,this.height),this.name=this.options.name;const s=this.options.attachments||[];if(0===s.length){for(let i=0;i<this.options.color;i++){const r={wrapS:this.gl.CLAMP_TO_EDGE,wrapT:this.gl.CLAMP_TO_EDGE,minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,type:this.gl.UNSIGNED_BYTE,format:this.gl.RGBA,flipY:!1,generateMipmaps:!1,...e};let n;n=r.data?new ks(t,r):new Gs(t,Xe(r,["data","name","attachments","depthTexture"])),s.push([this.gl.COLOR_ATTACHMENT0+i,n])}if(e.depthTexture&&(t.isWebGL2||!t.isWebGL2&&t.gl.getExtension("WEBGL_depth_texture"))){const e=new Gs(t,{width:this.width,height:this.height,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,format:this.gl.DEPTH_COMPONENT,internalFormat:t.isWebGL2?this.gl.DEPTH_COMPONENT16:this.gl.DEPTH_COMPONENT,type:this.gl.UNSIGNED_INT});s.push([this.gl.DEPTH_ATTACHMENT,e])}else{const{depth:i,stencil:r}=e;if(i&&!r){const e=new Ps(t,{format:this.gl.DEPTH_COMPONENT16,width:this.width,height:this.height});s.push([this.gl.DEPTH_ATTACHMENT,e])}else if(r&&!i){const e=new Ps(t,{format:this.gl.STENCIL_INDEX8,width:this.width,height:this.height});s.push([this.gl.STENCIL_ATTACHMENT,e])}else if(i&&r){const e=new Ps(t,{format:this.gl.DEPTH_STENCIL,width:this.width,height:this.height});s.push([this.gl.DEPTH_STENCIL_ATTACHMENT,e])}}}this.create(s)}get texture(){return this.#U.values().next().value}set clearColors(t){this.#P=t}get clearColors(){return this.#P}set clearDepth(t){this.#D=t}get clearDepth(){return this.#D}set clearStencil(t){this.#G=t}get clearStencil(){return this.#G}create(t){this.#P=[],this.#D=1,this.#G=0;for(const e of t){const t=e[0],s=e[1];s instanceof Ps?this.#I.set(t,s):s instanceof Gs&&(this.#U.set(t,s),this.drawBuffers.push(t));const i=t-this.gl.COLOR_ATTACHMENT0;this.#P[i]=[0,0,0,0]}if(this.options.color>1)if(this.renderer.isWebGL2)this.gl.drawBuffers(this.drawBuffers);else{const t=this.renderer.extension("WEBGL_draw_buffers");if(!t||!t.drawBuffersWEBGL)throw new Error("Please open the corresponding extension [WEBGL_draw_buffers](https://developer.mozilla.org/en-US/docs/Web/API/WEBGL_draw_buffers#browser_compatibility) and check whether the browser supports it");t.drawBuffersWEBGL(this.drawBuffers)}this.drawBuffersChanged=!0,this.bind(),this.#I.forEach(((t,e)=>{this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,e,this.gl.RENDERBUFFER,t.handle)})),this.#U.forEach(((t,e)=>{this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,e,this.gl.TEXTURE_2D,t.handle,0)})),this.unbind();const e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(e!==this.gl.FRAMEBUFFER_COMPLETE)switch(e){case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}return this.handle}clear(){this.bind();let t=0;if(this.clearColors[0]){const e=this.clearColors[0];this.gl.clearColor(e[0],e[1],e[2],e[3]),t|=this.gl.COLOR_BUFFER_BIT}Ve(this.#D)&&(this.gl.clearDepth(this.#D),t|=this.gl.DEPTH_BUFFER_BIT),Ve(this.#G)&&(this.gl.clearStencil(this.#G),t|=this.gl.STENCIL_BUFFER_BIT),this.gl.clear(t),this.unbind()}getTexture(t){return this.#U.get(t)}resize(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.#U.forEach((s=>{s.width===t&&s.height===e||(s.width=t,s.height=e,s.needsUpdate=!0,s.update())})),this.#I.forEach((s=>{s.resize(t,e)})),this.viewport.set(0,0,t,e))}bind(t=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(t,this.handle)}unbind(t=this.gl.FRAMEBUFFER){this.gl.bindFramebuffer(t,null)}removeStats(){}destroy(){this.#U.forEach((t=>{t.destroy()})),this.#I.forEach((t=>{t.destroy()})),this.deleteHandle()}createHandle(){return this.gl.createFramebuffer()}deleteHandle(){this.handle&&this.gl.deleteFramebuffer(this.handle)}toString(){return`RenderTarget(${this.id},${this.width}x${this.height})`}}function Ws(t,e,s,i,r=1,n=1,h=0,a=1,o=1,l=0,d=1,u=2,c=1,m=-1,g=0,p=0){const f=g,b=r/2,w=n/2,x=h/2,y=Math.floor(a),E=Math.floor(o),A=y+1,T=E+1,v=r/y,_=n/E;for(let r=0;r<T;r++){const n=r*_-w;for(let a=0;a<A;a++){if(t[3*g+l]=(a*v-b)*c,t[3*g+d]=n*m,t[3*g+u]=x,e[3*g+l]=0,e[3*g+d]=0,e[3*g+u]=h>=0?1:-1,s[2*g]=a/y,s[2*g+1]=1-r/E,g++,r===E||a===y)continue;const o=f+a+A*r,w=f+a+A*(r+1),T=f+a+1+A*(r+1),_=f+a+1+A*r;i[6*p]=o,i[6*p+1]=w,i[6*p+2]=_,i[6*p+3]=w,i[6*p+4]=T,i[6*p+5]=_,p++}}}class Vs extends Ms{constructor(t,{width:e=1,height:s=1,widthSegments:i=1,heightSegments:r=1,attributes:n={}}={}){const h=Math.floor(i),a=Math.floor(r),o=(h+1)*(a+1),l=h*a*6,d=new Float32Array(3*o),u=new Float32Array(3*o),c=new Float32Array(2*o),m=o>65536?new Uint32Array(l):new Uint16Array(l);Ws(d,u,c,m,e,s,0,i,r),super(t,{...n,position:{size:3,data:d},normal:{size:3,data:u},uv:{size:2,data:c},index:{data:m}})}}class js extends Ms{constructor(t,{width:e=1,height:s=1,depth:i=1,widthSegments:r=1,heightSegments:n=1,depthSegments:h=1,attributes:a={}}={}){const o=Math.floor(r),l=Math.floor(n),d=Math.floor(h),u=o+1,c=l+1,m=d+1,g=u*c*2+u*m*2+c*m*2,p=6*(o*l*2+o*d*2+l*d*2),f=new Float32Array(3*g),b=new Float32Array(3*g),w=new Float32Array(2*g),x=g>65536?new Uint32Array(p):new Uint16Array(p);let y=0,E=0;const A=m*c,T=u*m,v=u*c,_=d*l,M=o*d,S=o*l;Ws(f,b,w,x,i,s,e,h,n,2,1,0,-1,-1,y,E),y+=A,E+=_,Ws(f,b,w,x,i,s,-e,h,n,2,1,0,1,-1,y,E),y+=A,E+=_,Ws(f,b,w,x,e,i,s,h,r,0,2,1,1,1,y,E),y+=T,E+=M,Ws(f,b,w,x,e,i,-s,h,r,0,2,1,1,-1,y,E),y+=T,E+=M,Ws(f,b,w,x,e,s,-i,r,n,0,1,2,-1,-1,y,E),y+=v,E+=S,Ws(f,b,w,x,e,s,i,r,n,0,1,2,1,-1,y,E),super(t,{...a,position:{size:3,data:f},normal:{size:3,data:b},uv:{size:2,data:w},index:{data:x}})}}const Hs={};function qs(t="id"){Hs[t]=Hs[t]||1;const e=Hs[t];return Hs[t]+=1,"".concat(t,"-").concat(e)}const $s=(t,e)=>{switch(e){case t.VERTEX_SHADER:return"vertex-shader";case t.FRAGMENT_SHADER:return"fragment-shader";default:return"unknown"}};class Ys extends Is{#k;#z;sourceCode;constructor(t,e,s,i={}){const r=((t,e)=>{switch(e){case"fragment":return t.FRAGMENT_SHADER;case"vertex":return t.VERTEX_SHADER;default:return}})(t.gl,s);super(t,{name:Te(e)||qs($s(t,r))}),console.assert("string"==typeof e,"Shader: GLSL source code must be a JavaScript string"),this.#z=i,this.#k=r,this.sourceCode=this.injectShaderModule(e,i||{}).replace(/\n\n+/gm,"\n\n"),this.createShader(this.sourceCode)}injectShaderModule(t,e={}){return t.replace(/^[\t ]*#glsl_include +<([\w.]+)>/gm,((t,s)=>{let i=e[s];if(void 0===i)throw new Error("Cannot resolve #include <".concat(s,">"));return i=i.replace(/#include </g,"#glsl_include <"),this.injectShaderModule(i,e)}))}createShader(t=this.source){let e=t.replace(/#include </g,"#glsl_include <");if(e=this.injectShaderModule(e,this.#z||{}).replace(/\n\n+/gm,"\n\n"),this.gl.shaderSource(this.handle,e),this.gl.compileShader(this.handle),!this.gl.getShaderParameter(this.handle,this.gl.COMPILE_STATUS)){const t=this.gl.getShaderInfoLog(this.handle)||"";throw this.gl.deleteShader(this.handle),new Error(`${this.toString()}\n${t}\n${function(t){const e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}(e)}`)}}get source(){return this.sourceCode}get shaderType(){return this.#k}getSource(){return this.gl.getShaderSource(this.handle)}setSource(t){const e=Te(t);e&&(this.name=qs(e)),this.createShader(t)}removeStats(){}deleteHandle(){this.gl.deleteShader(this.handle)}toString(){return`${$s(this.gl,this.shaderType)}:${this.id}`}}class Xs extends Ys{constructor(t,e,s){super(t,e,"vertex",s)}createHandle(){return this.gl.createShader(this.gl.VERTEX_SHADER)}}class Zs extends Ys{constructor(t,e,s){super(t,e,"fragment",s)}createHandle(){return this.gl.createShader(this.gl.FRAGMENT_SHADER)}}const Ks={};function Qs(t,e,s,i){i=i.length?function(t){const e=t.length,s=t[0].length;if(void 0===s)return t;const i=e*s;let r=Ks[i];r||(Ks[i]=r=new Float32Array(i));for(let i=0;i<e;i++)r.set(t[i],i*s);return r}(i):i;const r=i.length;switch(e){case WebGLRenderingContext.FLOAT:return r?t.uniform1fv(s,i):t.uniform1f(s,i);case WebGLRenderingContext.FLOAT_VEC2:return t.uniform2fv(s,i);case WebGLRenderingContext.FLOAT_VEC3:return t.uniform3fv(s,i);case WebGLRenderingContext.FLOAT_VEC4:return t.uniform4fv(s,i);case WebGLRenderingContext.BOOL:case WebGLRenderingContext.INT:case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return r?t.uniform1iv(s,i):t.uniform1i(s,i);case WebGLRenderingContext.BOOL_VEC2:case WebGLRenderingContext.INT_VEC2:return t.uniform2iv(s,i);case WebGLRenderingContext.BOOL_VEC3:case WebGLRenderingContext.INT_VEC3:return t.uniform3iv(s,i);case WebGLRenderingContext.BOOL_VEC4:case WebGLRenderingContext.INT_VEC4:return t.uniform4iv(s,i);case WebGLRenderingContext.FLOAT_MAT2:return t.uniformMatrix2fv(s,!1,i);case WebGLRenderingContext.FLOAT_MAT3:return t.uniformMatrix3fv(s,!1,i);case WebGLRenderingContext.FLOAT_MAT4:return t.uniformMatrix4fv(s,!1,i)}}class Js extends Is{attributeOrder;uniforms;#W;#V;#j;#H;#q;constructor(t,e={}){super(t,e);const{id:s,vertexShader:i,fragmentShader:r,uniforms:n={},transparent:h=!1,defines:a=[],includes:o={},cullFace:l,frontFace:d=t.gl.CCW,depthTest:u=!0,depthWrite:c=!0,depthFunc:m=t.gl.LESS,blending:g=1,blendFunc:p,blendEquation:f}=e;this.id=s||Ye("program");const b=[...[].map((t=>"#define ".concat(t))),...a].map((t=>t.startsWith("#define ")?t:"#define ".concat(t)));if(!i||!r)throw new Error(`Program: ${this.id}：must provide vertexShader and fragmentShader`);if(this.#j="string"==typeof i?new Xs(t,Ae(i,b),o):i,this.#H="string"==typeof r?new Zs(t,Ae(r,b),o):r,this.gl.attachShader(this.handle,this.#j.handle),this.gl.attachShader(this.handle,this.#H.handle),this.gl.linkProgram(this.handle),this.gl.validateProgram(this.handle),!this.gl.getProgramParameter(this.handle,this.gl.LINK_STATUS))throw new Error("Program:".concat(this.id,": Error linking ").concat(this.gl.getProgramInfoLog(this.handle)));this.uniforms=n,this.#q={blending:g,cullFace:l,frontFace:d,depthTest:u,depthWrite:c,depthFunc:m,blendFunc:p,blendEquation:f},this.#W=new Map,this.#V=new Map,this.#$(n),this.#Y(),h&&!p?.src&&(this.renderer.premultipliedAlpha?this.#q.blendFunc={...p,src:this.gl.ONE,dst:this.gl.ONE_MINUS_SRC_ALPHA}:this.#q.blendFunc={...p,src:this.gl.SRC_ALPHA,dst:this.gl.ONE_MINUS_SRC_ALPHA})}get uniformLocations(){return this.#W}get attributeLocations(){return this.#V}get vertexShader(){return this.#j}get fragmentShader(){return this.#H}use(){const t=this.rendererState.currentProgramId===this.id;let e=-1;t||(this.gl.useProgram(this.handle),this.rendererState.currentProgramId=this.id),this.#W.forEach(((t,s)=>{const i=s.name,r=this.uniforms[i];if(!r)return void console.warn("Program:".concat(this.id,": Active uniform ").concat(i," has not been supplied"));if(r&&(ze(r.value)||He(r.value)))return void console.warn("Program:".concat(this.id,": Uniform ").concat(i," is missing a value parameter"));let n=r?.value;if(n instanceof Gs)return e+=1,r.value.update(e),Qs(this.gl,s.type,t.location,e);if((n instanceof gs||n instanceof os||n instanceof ys)&&(n=r.value.toArray()),n&&n.length>0&&n[0]instanceof Gs){const i=[];for(let t=0;t<r.value.length;t++){const s=n[t];e+=1,s.update(e),i.push(e)}return Qs(this.gl,s.type,t.location,i)}Qs(this.gl,s.type,t.location,n)})),this.applyState()}setStates(t,e=!0){e?(this.#q={...this.#q,...Xe(t,["blendFunc","blendEquation"])},t.blendFunc&&(this.#q.blendFunc={...this.#q.blendFunc,...t.blendFunc}),t.blendEquation&&(this.#q.blendEquation={...this.#q.blendEquation,...t.blendEquation})):this.#q=t}applyState(){this.rendererState.apply(this.#q)}setUniform(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}bind(){this.gl.useProgram(this.handle)}unbind(){this.gl.useProgram(null)}createHandle(){return this.gl.createProgram()}deleteHandle(){this.gl.deleteProgram(this.handle)}#$(t={}){const e=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_UNIFORMS);for(let s=0;s<e;s++){const e=this.gl.getActiveUniform(this.handle,s);if(!e)break;const i=e.name,r=i.match(/(\w+)/g),n={location:this.gl.getUniformLocation(this.handle,i),type:e.type,name:r[0],isStruct:!1};3===r.length?(n.isStructArray=!0,n.structIndex=Number(r[1]),n.structProperty=r[2]):2===r.length&&isNaN(Number(r[1]))&&(n.isStruct=!0,n.structProperty=r[1]);const h=t[i]?.value;ze(h)||He(h)||(n.value=t[i].value),this.uniforms[i]=n,this.#W.set(e,n)}}#Y(){const t=this.gl.getProgramParameter(this.handle,this.gl.ACTIVE_ATTRIBUTES),e=[];for(let s=0;s<t;s++){const t=this.gl.getActiveAttrib(this.handle,s);if(!t)break;const i=this.gl.getAttribLocation(this.handle,t.name);e[i]=t.name,this.#V.set(t,i)}this.attributeOrder=e.join("")}destroy(){this.unbind(),this.deleteHandle()}}class ti extends Gs{needsUpdate=!1;textureUnit=0;depth;#x={};constructor(t,e={}){const s=t.gl,i={target:s.TEXTURE_3D,type:s.UNSIGNED_BYTE,format:s.RGBA,internalFormat:e.format||s.RGBA,wrapS:s.CLAMP_TO_EDGE,wrapT:s.CLAMP_TO_EDGE,wrapR:s.CLAMP_TO_EDGE,generateMipmaps:!0,minFilter:s.LINEAR,magFilter:s.LINEAR,premultiplyAlpha:!1,unpackAlignment:4,flipY:!1,level:0,depth:0};super(t,Object.assign({},i,e),!1),this.needsUpdate=!0,this.depth=this.options.depth,this.#x.version=-1,this.update()}get gl(){return this.renderer.gl}setData(t,e=this.width,s=this.height,i=this.depth){this.image=t,this.width=e,this.height=s,this.depth=i,this.needsUpdate=!0}setOptions(t){this.options=Object.assign(this.options,t),this.width=this.options.width,this.height=this.options.height,this.depth=this.options.depth,this.needsUpdate=!0}update(t=0){const e=!(this.image===this.#x.image&&!this.needsUpdate);if((e||this.rendererState.textureUnits[t]!==this.id||this.rendererState.activeTextureUnit!==t)&&(this.rendererState.setActiveTexture(t),this.bind(t)),e){if(this.needsUpdate=!1,this.options.wrapS!==this.#x.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.options.wrapS),this.#x.wrapS=this.options.wrapS),this.options.wrapT!==this.#x.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.options.wrapT),this.#x.wrapT=this.options.wrapT),this.options.wrapR!==this.#x.wrapR&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_R,this.options.wrapR),this.#x.wrapR=this.options.wrapR),this.options.minFilter!==this.#x.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.options.minFilter),this.#x.minFilter=this.options.minFilter),this.options.magFilter!==this.#x.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.options.magFilter),this.#x.magFilter=this.options.magFilter),this.options.flipY!==this.rendererState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.options.flipY),this.rendererState.flipY=this.options.flipY),this.options.premultiplyAlpha!==this.rendererState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha),this.rendererState.premultiplyAlpha=this.options.premultiplyAlpha),this.options.unpackAlignment!==this.rendererState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.options.unpackAlignment),this.rendererState.unpackAlignment=this.options.unpackAlignment),this.options.anisotropy&&this.options.anisotropy!==this.rendererState.anisotropy){const t=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(t){const e=this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT);let s=this.options.anisotropy;this.options.anisotropy>e&&(s=e,console.warn(`[Texture]: Texture.anisotropy option exceeded the maximum allowed value ${e} of the device`)),this.gl.texParameterf(this.target,t.TEXTURE_MAX_ANISOTROPY_EXT,s)}this.rendererState.anisotropy=this.options.anisotropy}this.image?(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.renderer.isWebGL2&&Ve(this.options.offset)?this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,this.image,this.options.offset):(ArrayBuffer.isView(this.image),this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,this.image)),this.options.generateMipmaps&&(this.renderer.isWebGL2||Oe(this.image.width)&&Oe(this.image.height)?this.gl.generateMipmap(this.target):(this.options.generateMipmaps=!1,this.options.wrapS=this.gl.CLAMP_TO_EDGE,this.options.wrapT=this.options.wrapS,this.options.minFilter=this.gl.LINEAR))):this.width>0?this.gl.texImage3D(this.target,this.options.level,this.options.internalFormat,this.width,this.height,this.depth,0,this.options.format,this.options.type,null):this.gl.texImage3D(this.target,0,this.gl.RGBA,1,1,this.depth,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,Ds),this.#x.image=this.image,this.#x.version+=1}}removeStats(){this.#x={version:-1}}toString(){return`Texture3D(${this.id},${this.width}x${this.height})`}}const ei=new bs,si=new cs,ii=new cs;class ri extends As{cameraType;projectionMatrix;viewMatrix;projectionViewMatrix;worldPosition;#X;#Z;#K;#Q;#J;#m;frustum;constructor({near:t=.1,far:e=100,fov:s=45,aspect:i=1,bounds:r,zoom:n=1}={}){super(),this.cameraType="perspective",this.projectionMatrix=new Es,this.viewMatrix=new bs,this.projectionViewMatrix=new Es,this.worldPosition=new cs,this.frustum=new bs,this.#X=t,this.#Z=e,this.#K=s,this.#Q=i,this.#m=r,this.#J=n;const{left:h,right:a,top:o,bottom:l}=r||{};this.cameraType=h||a?"orthographic":"perspective","orthographic"===this.cameraType?this.orthographic(h,a,o,l,t,e,n):this.perspective(s,i,t,e)}get near(){return this.#X}set near(t){this.#X=t,this.updateProjectionMatrix()}get far(){return this.#Z}set far(t){this.#Z=t,this.updateProjectionMatrix()}get fov(){return this.#K}set fov(t){this.#K=t,this.updateProjectionMatrix()}get aspect(){return this.#Q}set aspect(t){this.#Q=t,this.updateProjectionMatrix()}get zoom(){return this.#J}set zoom(t){this.#J=t,this.updateProjectionMatrix()}get bounds(){return this.#m}set bounds(t){this.#m=t,this.updateProjectionMatrix()}perspective(t=this.fov,e=this.aspect,s=this.near,i=this.far){this.#K=t,this.#Q=e,this.#X=s,this.#Z=i,this.projectionMatrix.fromPerspective(t,e,s,i),this.cameraType="perspective"}orthographic(t,e,s,i,r=this.near,n=this.far,h=1){this.#m={left:t,right:e,top:s,bottom:i},this.near=r,this.far=n,this.projectionMatrix.orthographic(t/h,e/h,s/h,i/h,r,n),this.cameraType="orthographic",this.projectionMatrix.frustum(this.frustum,this.#m.left,this.#m.right,this.#m.top,this.#m.bottom,this.#X,this.#Z)}lookAt(t){return super.lookAt(t,!0),this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.invert(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}frustumIntersectsMesh(t,e=t.worldMatrix){if(!t.geometry.attributes.position)return!0;if(t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere(),!t.geometry.bounds)return!0;const s=si;s.copy(t.geometry.bounds.center),s.applyMatrix4(e);const i=t.geometry.bounds.radius*e.getMaxScaleOnAxis();return this.frustumIntersectsSphere(s,i)}frustumIntersectsSphere(t,e){const s=ii;for(let i=0;i<6;i++){const r=this.frustum[i];if(s.copy(r).dot(t)+r.constant<-e)return!1}return!0}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(ei.invert(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateProjectionMatrix(){throw new Error("Camera subclass must define virtual methods")}}class ni extends ri{constructor(t,e,s,i){super({fov:t,aspect:e,near:s,far:i})}updateProjectionMatrix(){this.projectionMatrix.fromPerspective(this.fov,this.aspect,this.near,this.far)}}class hi extends ri{constructor(t,e,s,i,r,n,h=1){super({bounds:{left:t,right:e,top:s,bottom:i},near:r,far:n,zoom:h})}updateProjectionMatrix(){const{left:t,right:e,top:s,bottom:i}=this.bounds,{zoom:r}=this;this.projectionMatrix.orthographic(t/r,e/r,s/r,i/r,this.near,this.far)}}export{Rs as BlendType,js as Box,vs as BufferAttribute,ri as Camera,is as Clock,ys as Color,ks as DataTexture,ws as Euler,as as EventEmitter,Ms as Geometry,ps as Matrix3,bs as Matrix4,Ss as Mesh,As as Object3D,hi as OrthographicCamera,ni as PerspectiveCamera,Vs as Plane,Js as Program,Es as ProjectionMatrix,us as Quaternion,ns as Raf,Ps as RenderBuffer,zs as RenderTarget,Ns as Renderer,Is as Resource,Fs as Scene,Cs as State,Gs as Texture,ti as Texture3D,ls as Vector2,cs as Vector3,ms as Vector4,Ws as getPlaneBuffer,Le as highPrecision,ss as utils};
